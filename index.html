<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Star of Ash — Deck Builder + Sheet Exporter (Embedded v9)</title>
<style>
:root { --bg:#0f0f13; --panel:#171923; --muted:#9aa0ac; --text:#e7e8ea; --accent:#b389ff; --ok:#6dd37a; --warn:#ffb84d; --bad:#ff6b6b; --line:#222633; }
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
header{padding:16px 20px;border-bottom:1px solid #222;display:flex;gap:12px;align-items:center;position:sticky;top:0;background:rgba(15,15,19,.95);backdrop-filter:saturate(140%) blur(6px);flex-wrap:wrap}
header h1{font-size:16px;margin:0;font-weight:700;letter-spacing:.4px}
.btn{padding:8px 12px;border-radius:10px;border:1px solid #2a2d3a;background:#1d2030;color:var(--text);cursor:pointer}
.btn:hover{border-color:#3a3f52} .btn.primary{background:var(--accent);border-color:var(--accent);color:#0e061a;font-weight:700}
.layout{display:grid;grid-template-columns:360px 1fr 380px;gap:16px;padding:16px}
.panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;overflow:hidden;display:flex;flex-direction:column;min-height:0}
.panel h2{margin:0;padding:12px 14px;border-bottom:1px solid #23283a;font-size:13px;letter-spacing:.3px;text-transform:uppercase;color:var(--muted)}
.panel .body{padding:12px;display:flex;flex-direction:column;gap:10px;min-height:0}
input,select{width:100%;background:#141722;border:1px solid #2a2d3a;color:var(--text);border-radius:10px;padding:8px;min-height:38px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.cards{overflow:auto;min-height:0;display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
.card{background:#141722;border:1px solid #252a3a;border-radius:12px;padding:10px;display:flex;flex-direction:column;gap:6px}
.tag{font-size:11px;color:#b7bdc9;background:#1e2230;border:1px solid #2a2f43;border-radius:999px;padding:2px 8px;margin-right:6px}
.name{font-weight:700} .muted{color:var(--muted)}
.deckcol{display:flex;flex-direction:column;gap:10px;min-height:0}
.list{overflow:auto;min-height:140px;border:1px dashed #2c3144;border-radius:12px;padding:8px;display:flex;flex-direction:column;gap:6px}
.li{display:flex;justify-content:space-between;gap:8px;border:1px solid #2a2d3a;background:#111421;border-radius:10px;padding:8px}
.counts{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
.pill{padding:6px 8px;border-radius:999px;text-align:center;background:#141722;border:1px solid #2a2d3a}
footer{padding:12px 16px;border-top:1px solid var(--line);display:flex;gap:8px;justify-content:flex-end}
.small{font-size:12px} canvas{max-width:100%;background:#0b0b0e;border:1px solid #2a2a2e;border-radius:12px}
.field{display:flex;flex-direction:column;gap:4px} .field label{font-size:11px;color:var(--muted)} .hint{font-size:11px;color:var(--muted)}
@media (max-width: 1200px){ .layout{grid-template-columns:1fr} } @media (max-width: 520px){ .grid{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <h1>Star of Ash — Deck Builder + Sheet Exporter</h1>
  <button id="exportJson" class="btn">Export Deck (JSON)</button>
  <button id="exportCsv" class="btn">Export Deck (CSV)</button>
  <button id="exportTxt" class="btn">Export Names (TXT)</button>
  <div class="small muted" id="status">Cards: v9 (normalized)</div>
</header>

<div class="layout">
  <section class="panel">
    <h2>Data & Presets</h2>
    <div class="body">
      <div class="grid">
        <div class="field"><label>Preset (starter deck)</label>
          <select id="presetSelect"></select>
        </div>
        <div class="field"><label>&nbsp;</label>
          <div class="row"><button id="loadPresetAppend" class="btn">Append</button><button id="loadPresetReplace" class="btn">Replace</button></div>
        </div>
      </div>

      <h2>Filters</h2>
      <div class="grid">
        <div class="field"><label>Faction</label><select id="faction">
          <option value="">All Factions</option><option>Flame</option><option>Blood</option><option>Ash</option>
          <option>Flame/Blood</option><option>Blood/Ash</option><option>Flame/Ash</option>
        </select></div>
        <div class="field"><label>Card Type</label><select id="type">
          <option value="">All Types</option><option>Creature</option><option>Spell</option><option>Relic</option><option>War Chief</option><option>Fragment</option>
        </select></div>
        <div class="field"><label>Search</label><input id="text" placeholder="Name, rules, flavor…" /></div>
        <div class="field"><label>Min Cost (est.)</label><input id="costMin" type="number" min="0" placeholder="0" /></div>
        <div class="field"><label>Max Cost (est.)</label><input id="costMax" type="number" min="0" placeholder="∞" /></div>
      </div>
      <div class="row"><button id="clear" class="btn">Clear Filters</button><div class="small muted" id="results"></div></div>

      <div class="row">
        <div class="field" style="min-width:180px"><label>Add Mode</label>
          <select id="addAllMode"><option value="auto">Add by Type (Auto)</option><option value="main">Add to Main</option><option value="frags">Add to Fragments</option><option value="chief">Add to War Chiefs</option></select>
        </div>
        <button id="addAllFiltered" class="btn">Add All (Filtered)</button>
        <button id="addAllAll" class="btn">Add All (Library)</button>
        <button id="clearDeck" class="btn">Clear Deck</button>
      </div>

      <h2>Card Sheet Exporter</h2>
      <div class="grid">
        <div class="field"><label>Source</label><select id="sheetSource"><option value="all">All Deck Sections</option><option value="main">Main Only</option><option value="frags">Fragments Only</option><option value="chief">War Chief Only</option></select></div>
        <div class="field"><label>Set Code (optional)</label><input id="setCode" placeholder="e.g., SOA-ALPHA" /></div>
        <div class="field"><label>Rows</label><input id="rows" type="number" min="1" value="7" /></div>
        <div class="field"><label>Columns</label><input id="cols" type="number" min="1" value="10" /></div>
        <div class="field"><label>Card Width (px)</label><input id="cardW" type="number" min="100" value="744" /></div>
        <div class="field"><label>Card Height (px)</label><input id="cardH" type="number" min="140" value="1038" /></div>
        <div class="field"><label>Bleed (px)</label><input id="bleed" type="number" min="0" value="36" /></div>
        <div class="field"><label>Margin (px)</label><input id="margin" type="number" min="0" value="24" /></div>
        <div class="field"><label>Export Scale (×)</label><input id="scale" type="number" min="1" step="0.25" value="1" /></div>
        <div class="field"><label>Name Scale (×)</label><input id="nameScale" type="number" min="0.5" step="0.1" value="1" /></div>
        <div class="field"><label>Rules Scale (×)</label><input id="rulesScale" type="number" min="0.5" step="0.1" value="1" /></div>
      </div>
      <div class="row">
        <button id="renderSheet" class="btn primary">Render Card Sheet</button>
        <button id="downloadSheet" class="btn">Download PNG</button>
        <button id="renderBacks" class="btn">Render Back Sheet</button>
        <button id="previewFull" class="btn">Open Large Preview</button>
        <button id="downloadAll" class="btn">Download ALL</button>
        <button id="previewAll" class="btn">Preview ALL</button>
      </div>
    <div class="grid">
  <div class="field">
    <label>Back Label</label>
    <input id="backLabel" placeholder="Star of Ash" />
  </div>

  <div class="field">
    <label>Back Color</label>
    <input id="backColor" type="color" value="#0b0b0e" />
  </div>

  <!-- NEW FEATURE: Card Background Color -->
  <div class="field">
    <label>Card Background Color</label>
    <input id="cardBgColor" type="color" value="#11151f" />
    <div class="hint">Helps visually distinguish decks during mirror matches.</div>
  </div>
</div>

      <canvas id="sheet" width="0" height="0"></canvas>
    </div>
  </section>

  <section class="panel"><h2>Cards</h2><div class="body" style="min-height:400px"><div class="cards" id="cards"></div></div></section>
  <section class="panel"><h2>Deck</h2><div class="body deckcol">
    <div class="counts"><div class="pill" id="countMain">Main: 0</div><div class="pill" id="countFrags">Fragments: 0</div><div class="pill" id="countChief">War Chiefs: 0</div></div>
    <div class="small muted">Main Deck (no limits)</div><div class="list" id="mainList"></div>
    <div class="small muted">Fragment Deck (no limits)</div><div class="list" id="fragList"></div>
    <div class="small muted">War Chiefs (no limits)</div><div class="list" id="chiefList"></div>
    <footer><button id="validate" class="btn primary">Summary</button><div id="validationMsg" class="small"></div></footer>
  </div></section>
</div>

<script>
(()=>{
// ===== Embedded data (v9 normalized) =====
const RAW_V9_CARDS = [
  {
    "Name": "Ashen Lancer",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "3 Flame Fragments",
    "ATK": 5,
    "HP": 3,
    "Rules Text": "Overheat 1 — When this attacks, it gains +1 ATK this turn, then takes 1 damage at end of turn."
  },
  {
    "Name": "Ashfield Militia",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "2 Flame Fragments",
    "ATK": 4,
    "HP": 3,
    "Rules Text": ""
  },
  {
    "Name": "Blazeborn Duelist",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "3 Flame Fragments",
    "ATK": 3,
    "HP": 4,
    "Rules Text": "Ignite — When this deals damage, adjacent enemies to the target take 1 damage."
  },
  {
    "Name": "Brimstone Runner",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "3 Flame Fragments",
    "ATK": 4,
    "HP": 2,
    "Rules Text": ""
  },
  {
    "Name": "Charwalker",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "3 Flame Fragments",
    "ATK": 2,
    "HP": 4,
    "Rules Text": ""
  },
  {
    "Name": "Cinderblade Adept",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "4 Flame Fragments",
    "ATK": 4,
    "HP": 3,
    "Rules Text": "Surge — This unit may move and attack during the same turn."
  },
  {
    "Name": "Cinderline Scout",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "3 Flame Fragments",
    "ATK": 3,
    "HP": 2,
    "Rules Text": ""
  },
  {
    "Name": "Coalbrand Skirmisher",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "2 Flame Fragments",
    "ATK": 3,
    "HP": 4,
    "Rules Text": ""
  },
  {
    "Name": "Emberfoot Soldier",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "2 Flame Fragments",
    "ATK": 3,
    "HP": 3,
    "Rules Text": ""
  },
  {
    "Name": "Embergale Striker",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "4 Flame Fragments",
    "ATK": 3,
    "HP": 5,
    "Rules Text": "Molten Shield — Prevent the first 1 damage dealt to this each turn."
  },
  {
    "Name": "Emberstorm Herald",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "5 Flame Fragments",
    "ATK": 6,
    "HP": 3,
    "Rules Text": "Commanded Flame — When you cast a Spell, this gains +1 ATK until end of turn."
  },
  {
    "Name": "Fireset Sentry",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "3 Flame Fragments",
    "ATK": 3,
    "HP": 3,
    "Rules Text": ""
  },
  {
    "Name": "Flamewake Stalker",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "4 Flame Fragments",
    "ATK": 3,
    "HP": 4,
    "Rules Text": "Flow East — At the end of your turn, move this 1 tile east if unoccupied."
  },
  {
    "Name": "Heatwave Vanguard",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "4 Flame Fragments",
    "ATK": 5,
    "HP": 2,
    "Rules Text": "Rekindle — When this destroys a unit, heal 1 HP."
  },
  {
    "Name": "Ignition Raider",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "4 Flame Fragments",
    "ATK": 4,
    "HP": 3,
    "Rules Text": "Rend — Attacks pierce through the first enemy hit and deal -1 damage to the next unit in line."
  },
  {
    "Name": "Inferno Harrier",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "3 Flame Fragments",
    "ATK": 4,
    "HP": 2,
    "Rules Text": "Flow Forward — At the end of your turn, move this 1 tile forward if unoccupied."
  },
  {
    "Name": "Kindling Spearhand",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "2 Flame Fragments",
    "ATK": 3,
    "HP": 3,
    "Rules Text": ""
  },
  {
    "Name": "Molten Shocktroop",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "4 Flame Fragments",
    "ATK": 5,
    "HP": 4,
    "Rules Text": "Eruption (-): When this attacks, after damage resolve, deal 1 damage in a line forward (friendly fire)."
  },
  {
    "Name": "Pyreforge Guard",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "3 Flame Fragments",
    "ATK": 2,
    "HP": 3,
    "Rules Text": ""
  },
  {
    "Name": "Pyreheart Champion",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "5 Flame Fragments",
    "ATK": 5,
    "HP": 3,
    "Rules Text": "When Deployed — Allies in its column gain +1 ATK this turn. Overheat 1."
  },
  {
    "Name": "Pyreplate Bruiser",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "3 Flame Fragments",
    "ATK": 3,
    "HP": 5,
    "Rules Text": "Swift — This unit may act on the turn it is deployed (move or attack)."
  },
  {
    "Name": "Scorchwing Captain",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "6 Flame Fragments",
    "ATK": 4,
    "HP": 5,
    "Rules Text": "Swift. Rend — Attacks pierce; the second target takes -1 damage."
  },
  {
    "Name": "Searbrand Marauder",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "3 Flame Fragments",
    "ATK": 4,
    "HP": 3,
    "Rules Text": "Ember Step — When this moves, gain +1 ATK until end of turn."
  },
  {
    "Name": "Torchline Pikeman",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "2 Flame Fragments",
    "ATK": 4,
    "HP": 3,
    "Rules Text": ""
  },
  {
    "Name": "Volcanic Reaver",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "4 Flame Fragments",
    "ATK": 4,
    "HP": 4,
    "Rules Text": "When Deployed — Eruption (+): deal 2 damage (friendly fire). Surge — This may move and attack during the same turn."
  },
  {
    "Name": "Ashen War-Drum",
    "Faction": "Flame",
    "Type": "Relic",
    "Cost": "2 Flame Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Allies in the center column gain +1 ATK. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Brimwall Bulwark",
    "Faction": "Flame",
    "Type": "Relic",
    "Cost": "4 Flame Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Prevent the first 2 damage dealt to your units each turn; those units take 1 damage at end of turn (overheat). (Relic overwrite rules apply.)"
  },
  {
    "Name": "Cinder Gate",
    "Faction": "Flame",
    "Type": "Relic",
    "Cost": "3 Flame Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Eruption (+): When you deploy a creature, deal 1 damage (friendly fire). (Relic overwrite rules apply.)"
  },
  {
    "Name": "Crown of Sparks",
    "Faction": "Flame",
    "Type": "Relic",
    "Cost": "2 Flame Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Your Spells cost 1 less Fragment this turn after a creature dies. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Crucible Array",
    "Faction": "Flame",
    "Type": "Relic",
    "Cost": "2 Flame Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Once per turn, you may move an allied unit 1 tile after it attacks. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Emberfont Standard",
    "Faction": "Flame",
    "Type": "Relic",
    "Cost": "3 Flame Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "At end of your turn, create a Flamefield on a random empty tile in your front two rows. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Flamewheel Engine",
    "Faction": "Flame",
    "Type": "Relic",
    "Cost": "4 Flame Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Relic Fuse — You may destroy this: deal 3 damage to a unit in line of sight. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Infernal Beacon",
    "Faction": "Flame",
    "Type": "Relic",
    "Cost": "2 Flame Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Allied Flame units gain +1 ATK this turn when they move. (Newest Relic overrides oldest; max 4 Relics total between both players.)"
  },
  {
    "Name": "Mantle of the Forge",
    "Faction": "Flame",
    "Type": "Relic",
    "Cost": "4 Flame Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Allied units entering Flamefields gain +1 ATK until end of turn. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Pyreline Banner",
    "Faction": "Flame",
    "Type": "Relic",
    "Cost": "3 Flame Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "When an allied unit destroys an enemy, draw 1 card. Pay 1 HP to keep this Relic at end of turn; otherwise destroy it. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Ashfall Surge",
    "Faction": "Flame",
    "Type": "Spell",
    "Cost": "2 Flame Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Move an allied unit 1 tile, then it gains +1 ATK this turn. You may cast this on any player's turn."
  },
  {
    "Name": "Brand the Earth",
    "Faction": "Flame",
    "Type": "Spell",
    "Cost": "2 Flame Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Target allied unit gains Surge until end of turn. You may cast this on any player's turn."
  },
  {
    "Name": "Crossflare",
    "Faction": "Flame",
    "Type": "Spell",
    "Cost": "3 Flame Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Until end of turn, two target allies gain +1 ATK. You may cast this on any player's turn."
  },
  {
    "Name": "Emberlash",
    "Faction": "Flame",
    "Type": "Spell",
    "Cost": "3 Flame Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Create a Flamefield on an empty tile within 2 tiles of a Flame unit. You may cast this on any player's turn."
  },
  {
    "Name": "Forge-Fire Volley",
    "Faction": "Flame",
    "Type": "Spell",
    "Cost": "1 Flame Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Choose a column: enemies in that column take 1 damage. You may cast this on any player's turn."
  },
  {
    "Name": "Line of Cinders",
    "Faction": "Flame",
    "Type": "Spell",
    "Cost": "2 Flame Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Eruption (+) — Deal 2 damage in a cross (friendly fire). You may cast this on any player's turn."
  },
  {
    "Name": "Pyreburst",
    "Faction": "Flame",
    "Type": "Spell",
    "Cost": "1 Flame Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Eruption (-) — Deal 2 damage in a line (friendly fire). You may cast this on any player's turn."
  },
  {
    "Name": "Scorching Advance",
    "Faction": "Flame",
    "Type": "Spell",
    "Cost": "1 Flame Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Choose a Flamefield: push all units adjacent to it 1 tile away. You may cast this on any player's turn."
  },
  {
    "Name": "Sear the Ranks",
    "Faction": "Flame",
    "Type": "Spell",
    "Cost": "3 Flame Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Destroy target Sigil or reduce a Relic's effect by half until your next turn. You may cast this on any player's turn."
  },
  {
    "Name": "High Pyre Commander",
    "Faction": "Flame",
    "Type": "War Chief",
    "Cost": "0 Flame Fragments",
    "ATK": 0,
    "HP": 40,
    "Rules Text": "Command (Free, 1/turn) — Choose a friendly Flame unit: it gains +1 ATK this turn and triggers Eruption (+) for 1 damage (friendly fire). Command (1 Flame Fragment, 1/turn) — Eruption (-) for 2 damage (friendly fire). War Chiefs cannot attack and may only move left or right in their back row."
  },
  {
    "Name": "Bleak Surgeon",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "4 Blood Fragments",
    "ATK": 3,
    "HP": 5,
    "Rules Text": "Gravecall — When this dies, you may spend 1 Blood Fragment to deploy it with -1 HP."
  },
  {
    "Name": "Blood-Quenched Sentinel",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "2 Blood Fragments",
    "ATK": 3,
    "HP": 4,
    "Rules Text": ""
  },
  {
    "Name": "Bloodkeep Legionary",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "4 Blood Fragments",
    "ATK": 3,
    "HP": 6,
    "Rules Text": "Life Tithe — Pay 1 HP: draw 1 card. Use once each of your turns."
  },
  {
    "Name": "Carnage Reclaimer",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "5 Blood Fragments",
    "ATK": 4,
    "HP": 6,
    "Rules Text": "Gravebond — When a friendly creature dies, this gains +1 ATK until end of turn. Feast."
  },
  {
    "Name": "Clotline Soldier",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "2 Blood Fragments",
    "ATK": 3,
    "HP": 5,
    "Rules Text": ""
  },
  {
    "Name": "Crimson Houndmaster",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "3 Blood Fragments",
    "ATK": 2,
    "HP": 6,
    "Rules Text": "Essence Surge — Whenever you heal, an enemy in line of sight gets -1 ATK until end of turn."
  },
  {
    "Name": "Crimson Servitor",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "2 Blood Fragments",
    "ATK": 2,
    "HP": 5,
    "Rules Text": ""
  },
  {
    "Name": "Fleshmarket Warden",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "6 Blood Fragments",
    "ATK": 3,
    "HP": 8,
    "Rules Text": "Relic Feeder — At end of your turn, you may sacrifice a friendly Summon: draw 1 card."
  },
  {
    "Name": "Fleshshaper Acolyte",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "3 Blood Fragments",
    "ATK": 3,
    "HP": 5,
    "Rules Text": "Guard — Enemies must attack this first if able."
  },
  {
    "Name": "Gorefane Watch",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "3 Blood Fragments",
    "ATK": 2,
    "HP": 6,
    "Rules Text": ""
  },
  {
    "Name": "Gravebond Champion",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "4 Blood Fragments",
    "ATK": 5,
    "HP": 6,
    "Rules Text": "Command the Vein — When you cast a Spell, heal 1 to a friendly creature; then an enemy in line loses 1 ATK this turn."
  },
  {
    "Name": "Gravetithe Collector",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "3 Blood Fragments",
    "ATK": 4,
    "HP": 5,
    "Rules Text": "Sigilmaker — You may place a Sigil face-down on an adjacent empty tile (triggers when stepped on)."
  },
  {
    "Name": "Grim Vicar",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "4 Blood Fragments",
    "ATK": 2,
    "HP": 6,
    "Rules Text": "Ritual Draw — When you destroy a unit, draw 1 card if your War Chief took damage this turn."
  },
  {
    "Name": "Hemlock Ward",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "3 Blood Fragments",
    "ATK": 2,
    "HP": 5,
    "Rules Text": ""
  },
  {
    "Name": "Matriarch of the Tithe",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "4 Blood Fragments",
    "ATK": 4,
    "HP": 7,
    "Rules Text": "When Deployed — Sacrifice another friendly creature: destroy an enemy with HP ≤ the sacrificed creature's HP."
  },
  {
    "Name": "Ritual Butcher",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "3 Blood Fragments",
    "ATK": 3,
    "HP": 5,
    "Rules Text": "Feast — When a unit dies on an adjacent tile, this heals 1 HP."
  },
  {
    "Name": "Sanguine Duelist",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "3 Blood Fragments",
    "ATK": 3,
    "HP": 5,
    "Rules Text": "Sacrificial Pact — Sacrifice a friendly creature: destroy an enemy with HP ≤ the sacrificed creature's HP."
  },
  {
    "Name": "Sanguine Harvester",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "5 Blood Fragments",
    "ATK": 5,
    "HP": 5,
    "Rules Text": "Claim the Blood — When this destroys a unit, you may pay 1 Blood Fragment: deploy it from your discard with -1 HP."
  },
  {
    "Name": "Scarlet Overseer",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "4 Blood Fragments",
    "ATK": 3,
    "HP": 6,
    "Rules Text": "Crimson Dice — When this enters, roll a d6. (1–3: gain 2 HP. 4–6: deal 2 to an enemy.)"
  },
  {
    "Name": "Sinew Pikebearer",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "2 Blood Fragments",
    "ATK": 3,
    "HP": 5,
    "Rules Text": ""
  },
  {
    "Name": "Thirstsworn Aide",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "3 Blood Fragments",
    "ATK": 2,
    "HP": 5,
    "Rules Text": ""
  },
  {
    "Name": "Veinbound Guard",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "3 Blood Fragments",
    "ATK": 2,
    "HP": 4,
    "Rules Text": ""
  },
  {
    "Name": "Veinspeaker Adept",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "4 Blood Fragments",
    "ATK": 2,
    "HP": 6,
    "Rules Text": "Dominion — Enemies entering adjacent tiles lose 1 ATK until your next turn."
  },
  {
    "Name": "Veinwhip Enforcer",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "3 Blood Fragments",
    "ATK": 4,
    "HP": 4,
    "Rules Text": "Flesh Armor — If this would die, you may sacrifice another friendly creature instead."
  },
  {
    "Name": "Vessel-Cutter",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "4 Blood Fragments",
    "ATK": 3,
    "HP": 5,
    "Rules Text": "Retaliate 1 — When damaged, deal 1 back to the source."
  },
  {
    "Name": "Blood Altar",
    "Faction": "Blood",
    "Type": "Relic",
    "Cost": "2 Blood Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Whenever a unit dies, heal your War Chief 1 HP. (Newest Relic overrides oldest; max 4 Relics total between both players.)"
  },
  {
    "Name": "Bone-Thread Loom",
    "Faction": "Blood",
    "Type": "Relic",
    "Cost": "2 Blood Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Crimson Chant — Enemies on Bloodpools have -1 ATK. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Chalice of Tithes",
    "Faction": "Blood",
    "Type": "Relic",
    "Cost": "3 Blood Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Vessel's Boon — The first time an ally dies each turn, gain 1 temporary Fragment (Blood) this turn only. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Crimson Court Standard",
    "Faction": "Blood",
    "Type": "Relic",
    "Cost": "4 Blood Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Blood Ward — Allied creatures gain Guard this turn when healed. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Crucible of Flesh",
    "Faction": "Blood",
    "Type": "Relic",
    "Cost": "2 Blood Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Life Tithe — Once per turn you may pay 2 HP: draw 1 card. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Gorewheel",
    "Faction": "Blood",
    "Type": "Relic",
    "Cost": "4 Blood Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Tithe Counter — At end of your turn, if two or more enemies died, create a Bloodpool under one of them. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Red Chorus",
    "Faction": "Blood",
    "Type": "Relic",
    "Cost": "3 Blood Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Flesh Market — When you sacrifice a unit, draw 1 card. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Sanguine Font",
    "Faction": "Blood",
    "Type": "Relic",
    "Cost": "4 Blood Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "At end of your turn, spread a Bloodpool to an adjacent empty tile of a Blood unit. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Vat of Renewal",
    "Faction": "Blood",
    "Type": "Relic",
    "Cost": "2 Blood Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Relic Scour — When an ally is healed, on a roll of 5–6 destroy a random enemy Relic. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Vein-Scribed Sigil",
    "Faction": "Blood",
    "Type": "Relic",
    "Cost": "3 Blood Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Sigils you control deal +1 damage and apply Bleed (1). (Relic overwrite rules apply.)"
  },
  {
    "Name": "Blood Price",
    "Faction": "Blood",
    "Type": "Spell",
    "Cost": "3 Blood Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Blood Price — Pay 2 HP: draw 2 cards. You may cast this on any player's turn."
  },
  {
    "Name": "Claim the Fallen",
    "Faction": "Blood",
    "Type": "Spell",
    "Cost": "1 Blood Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Claim the Fallen — Pay 1 Blood Fragment: deploy a creature with cost ≤ 3 from your discard with -1 HP. You may cast this on any player's turn."
  },
  {
    "Name": "Crimson Cross",
    "Faction": "Blood",
    "Type": "Spell",
    "Cost": "2 Blood Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Ripple (x) — Drain 1 HP diagonally around the target; heal allies by the same amount. You may cast this on any player's turn."
  },
  {
    "Name": "Harvest Call",
    "Faction": "Blood",
    "Type": "Spell",
    "Cost": "3 Blood Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Harvest Call — If a unit died this turn, draw 1 card. Otherwise, discard 1 card. You may cast this on any player's turn."
  },
  {
    "Name": "Hemorrhage Line",
    "Faction": "Blood",
    "Type": "Spell",
    "Cost": "1 Blood Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Ripple (+) — Drain 1 HP from enemies in a cross; heal allies by the same amount. You may cast this on any player's turn."
  },
  {
    "Name": "Leeching March",
    "Faction": "Blood",
    "Type": "Spell",
    "Cost": "2 Blood Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Leeching March — Until end of turn, when allies deal damage, heal your War Chief 1 HP. You may cast this on any player's turn."
  },
  {
    "Name": "Pulse of the Vein",
    "Faction": "Blood",
    "Type": "Spell",
    "Cost": "2 Blood Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Pulse of the Vein — Choose an enemy: it gets -2 ATK until your next turn. You may cast this on any player's turn."
  },
  {
    "Name": "Ritual Rebuke",
    "Faction": "Blood",
    "Type": "Spell",
    "Cost": "1 Blood Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Ritual Rebuke — Sacrifice a friendly creature: destroy an enemy with HP ≤ the sacrificed creature's HP. You may cast this on any player's turn."
  },
  {
    "Name": "Vessel's Command",
    "Faction": "Blood",
    "Type": "Spell",
    "Cost": "3 Blood Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Vessel's Command — Choose a tile on a Bloodpool: enemies adjacent take 1 damage. You may cast this on any player's turn."
  },
  {
    "Name": "Crimson Matriarch",
    "Faction": "Blood",
    "Type": "War Chief",
    "Cost": "0 Blood Fragments",
    "ATK": 0,
    "HP": 45,
    "Rules Text": "Command (Free, 1/turn) — Ripple (+): Drain 1 HP from enemies around a friendly Blood unit; heal your War Chief by the total drained. Command (1 Blood Fragment, 1/turn) — Create Bloodpools on up to two empty tiles adjacent to Blood units you control. War Chiefs cannot attack and may only move left or right in their back row."
  },
  {
    "Name": "Ashbound Walker",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "2 Ash Fragments",
    "ATK": 3,
    "HP": 3,
    "Rules Text": ""
  },
  {
    "Name": "Ashen Interdictor",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "3 Ash Fragments",
    "ATK": 3,
    "HP": 4,
    "Rules Text": "Obsidian Step — When this moves, create a Shadow Tile on its previous tile."
  },
  {
    "Name": "Bonewraith",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "2 Ash Fragments",
    "ATK": 2,
    "HP": 4,
    "Rules Text": ""
  },
  {
    "Name": "Cinder Shade",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "4 Ash Fragments",
    "ATK": 3,
    "HP": 4,
    "Rules Text": "Shroud — Takes 1 less damage from all sources this turn after moving."
  },
  {
    "Name": "Cinder Veilguard",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "3 Ash Fragments",
    "ATK": 2,
    "HP": 5,
    "Rules Text": ""
  },
  {
    "Name": "Dust-Crown Herald",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "5 Ash Fragments",
    "ATK": 5,
    "HP": 4,
    "Rules Text": "Quiet Command — When this destroys a unit, you may pay 1 Ash Fragment: deploy a 1/1 Wraith token on an adjacent empty tile."
  },
  {
    "Name": "Dustmarch Scout",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "3 Ash Fragments",
    "ATK": 2,
    "HP": 5,
    "Rules Text": ""
  },
  {
    "Name": "Funeral Pike",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "2 Ash Fragments",
    "ATK": 3,
    "HP": 4,
    "Rules Text": ""
  },
  {
    "Name": "Grave Echo",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "4 Ash Fragments",
    "ATK": 3,
    "HP": 4,
    "Rules Text": "Ascend — When this moves to your back row, it gains +2 ATK."
  },
  {
    "Name": "Graveclutch Champion",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "4 Ash Fragments",
    "ATK": 5,
    "HP": 5,
    "Rules Text": "Obsidian Surge — When you cast a Spell, create a Shadow Tile on an empty adjacent tile."
  },
  {
    "Name": "Gravecold Footman",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "2 Ash Fragments",
    "ATK": 3,
    "HP": 3,
    "Rules Text": ""
  },
  {
    "Name": "Graveyard Sentinel",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "3 Ash Fragments",
    "ATK": 2,
    "HP": 4,
    "Rules Text": ""
  },
  {
    "Name": "Hauntweaver",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "3 Ash Fragments",
    "ATK": 2,
    "HP": 5,
    "Rules Text": "Reclaim — When this is deployed from your discard, draw 1 card."
  },
  {
    "Name": "Mournblade Stalker",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "3 Ash Fragments",
    "ATK": 3,
    "HP": 3,
    "Rules Text": "Wraithcall — When this dies, create a 1/1 Wraith token on its tile."
  },
  {
    "Name": "Mourning Blade",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "3 Ash Fragments",
    "ATK": 2,
    "HP": 4,
    "Rules Text": ""
  },
  {
    "Name": "Night-Quiet Lancer",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "4 Ash Fragments",
    "ATK": 2,
    "HP": 5,
    "Rules Text": "Grave Siphon — When an enemy dies adjacent, heal your War Chief 1 HP."
  },
  {
    "Name": "Obsidian Channeler",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "4 Ash Fragments",
    "ATK": 2,
    "HP": 5,
    "Rules Text": "Channel — If aligned in the same row or column with another allied Channel card, both gain +1 ATK."
  },
  {
    "Name": "Obsidian Revenant",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "6 Ash Fragments",
    "ATK": 4,
    "HP": 6,
    "Rules Text": "Dustbound — While on a Shadow Tile, this has +1 ATK and Guard."
  },
  {
    "Name": "Obsidian Skirmisher",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "2 Ash Fragments",
    "ATK": 3,
    "HP": 4,
    "Rules Text": ""
  },
  {
    "Name": "Shade-Touched Guard",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "3 Ash Fragments",
    "ATK": 2,
    "HP": 4,
    "Rules Text": ""
  },
  {
    "Name": "Shadowbind Adept",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "3 Ash Fragments",
    "ATK": 3,
    "HP": 4,
    "Rules Text": "Shadow Bind — Enemies on Shadow Tiles cannot move."
  },
  {
    "Name": "Shroud Watcher",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "4 Ash Fragments",
    "ATK": 3,
    "HP": 4,
    "Rules Text": "Night Veil — Enemies adjacent have -1 ATK."
  },
  {
    "Name": "Stillborn Regent",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "4 Ash Fragments",
    "ATK": 4,
    "HP": 5,
    "Rules Text": "When Deployed — Bloom (x): create Shadow Tiles diagonally around the target tile."
  },
  {
    "Name": "Warden of the Quiet",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "5 Ash Fragments",
    "ATK": 4,
    "HP": 5,
    "Rules Text": "Grave Conductor — When a friendly unit dies, you may move an allied unit 1 tile."
  },
  {
    "Name": "Wraith-Caller",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "3 Ash Fragments",
    "ATK": 3,
    "HP": 4,
    "Rules Text": "Haunt — When this dies, its tile becomes haunted; enemies entering take 1 damage."
  },
  {
    "Name": "Black Sigil Stone",
    "Faction": "Ash",
    "Type": "Relic",
    "Cost": "4 Ash Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Sepulcher Echo — The first time an ally dies each turn, draw 1 card and then discard 1 card. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Catafalque Standard",
    "Faction": "Ash",
    "Type": "Relic",
    "Cost": "3 Ash Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "At the end of your turn, you may convert a Ruins tile into a Shadow Tile. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Funerary Ring",
    "Faction": "Ash",
    "Type": "Relic",
    "Cost": "3 Ash Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Silencing Pall — Enemies who enter Shadow Tiles cannot cast Spells until end of turn. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Graveglass Mirror",
    "Faction": "Ash",
    "Type": "Relic",
    "Cost": "2 Ash Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "When you cast a Spell, create a Shadow Tile on an empty tile adjacent to your War Chief. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Lamp of the Unquiet",
    "Faction": "Ash",
    "Type": "Relic",
    "Cost": "4 Ash Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "When an allied unit dies, 25% chance to deploy a 1/1 Wraith token on its tile. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Mortuary Engine",
    "Faction": "Ash",
    "Type": "Relic",
    "Cost": "3 Ash Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Gravetide — At end of your turn, if two enemies died this turn, create Shadow Tiles (+) around your War Chief. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Obsidian Shrine",
    "Faction": "Ash",
    "Type": "Relic",
    "Cost": "2 Ash Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Allied units on Shadow Tiles gain +1 ATK; enemies on Shadow Tiles have -1 ATK. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Pall of Silence",
    "Faction": "Ash",
    "Type": "Relic",
    "Cost": "2 Ash Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Obsidian Web — Enemies moving off Shadow Tiles take 1 damage. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Sepulcher Banner",
    "Faction": "Ash",
    "Type": "Relic",
    "Cost": "2 Ash Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Lamp of the Unquiet — Once per turn, you may move a Shadow Tile 1 space. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Urn of the Forgotten",
    "Faction": "Ash",
    "Type": "Relic",
    "Cost": "4 Ash Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "While you control 3+ Shadow Tiles, allied creatures gain +1 HP. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Cross of Ashes",
    "Faction": "Ash",
    "Type": "Spell",
    "Cost": "2 Ash Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Bloom (+) — Create Shadow Tiles in a cross centered on target. You may cast this on any player's turn."
  },
  {
    "Name": "Entomb Memory",
    "Faction": "Ash",
    "Type": "Spell",
    "Cost": "3 Ash Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Entomb Memory — Put the top 2 cards of your deck into your discard; then draw 1. You may cast this on any player's turn."
  },
  {
    "Name": "Funeral March",
    "Faction": "Ash",
    "Type": "Spell",
    "Cost": "3 Ash Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Funeral March — Move up to two allied units 1 tile each. You may cast this on any player's turn."
  },
  {
    "Name": "Gravewind",
    "Faction": "Ash",
    "Type": "Spell",
    "Cost": "1 Ash Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Gravewind — Move a Shadow Tile 1 space; enemies it passes over take 1 damage. You may cast this on any player's turn."
  },
  {
    "Name": "Line of Dust",
    "Faction": "Ash",
    "Type": "Spell",
    "Cost": "3 Ash Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Bloom (-) — In a line, turn up to 3 empty tiles into Shadow Tiles. You may cast this on any player's turn."
  },
  {
    "Name": "Night's Claim",
    "Faction": "Ash",
    "Type": "Spell",
    "Cost": "2 Ash Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Night's Claim — Choose an enemy on a Shadow Tile: it cannot move next turn. You may cast this on any player's turn."
  },
  {
    "Name": "Shadow Bloom",
    "Faction": "Ash",
    "Type": "Spell",
    "Cost": "1 Ash Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Bloom (x) — Create Shadow Tiles diagonally around the target. You may cast this on any player's turn."
  },
  {
    "Name": "Silence the Living",
    "Faction": "Ash",
    "Type": "Spell",
    "Cost": "2 Ash Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Silence the Living — Target enemy loses 2 ATK until your next turn. You may cast this on any player's turn."
  },
  {
    "Name": "Wraithwalk",
    "Faction": "Ash",
    "Type": "Spell",
    "Cost": "1 Ash Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Wraithwalk — Target allied unit gains Swift until end of turn. You may cast this on any player's turn."
  },
  {
    "Name": "Warden of the Stillborn",
    "Faction": "Ash",
    "Type": "War Chief",
    "Cost": "0 Ash Fragments",
    "ATK": 0,
    "HP": 42,
    "Rules Text": "Command (Free, 1/turn) — Choose an empty tile adjacent to a fallen ally: deploy a 1/1 Wraith token. Command (1 Ash Fragment, 1/turn) — Bloom (x): Create Shadow Tiles on diagonally adjacent tiles of a chosen space. War Chiefs cannot attack and may only move left or right in their back row."
  }
];
function normalizeCard(c){
  const name   = c.Name ?? c.name ?? '';
  const faction= c.Faction ?? c.faction ?? '';
  const type   = c.Type ?? c.type ?? '';
  const cost   = c.Cost ?? c.cost ?? '';
  const atk    = (c.ATK ?? c.atk ?? '').toString();
  const hp     = (c.HP  ?? c.hp  ?? '').toString();
  const text   = c['Rules Text'] ?? c.text ?? '';
  const flavor = c['Flavor Text'] ?? c.flavor ?? '';
  return { name, faction, type, cost, atk, hp, text, flavor };
}
const RAW_FRAGMENT_CARDS = [
  {
    "Name": "Ash Fragment",
    "Faction": "Ash",
    "Type": "Fragment",
    "Cost": "",
    "ATK": "",
    "HP": "",
    "Rules Text": "ProvidesBurn: Provides 🕯️ Ash to cast creatures, spells, or relics.\nReburn: Instead of exiling, shuffle this Fragment into your Fragment Deck.\nFlavor: “Even dust remembers the flame.”",
    "Flavor Text": ""
  },
  {
    "Name": "Ash Fragment",
    "Faction": "Ash",
    "Type": "Fragment",
    "Cost": "—",
    "ATK": "—",
    "HP": "—",
    "Rules Text": "Burn: Provides 1 Ash resource. Reburn: Instead of exiling, shuffle this Fragment back into your Fragment Deck.",
    "Flavor Text": "What burns to ash may rise again, ever circling."
  },
  {
    "Name": "Dust-Etched Fragment",
    "Faction": "Ash",
    "Type": "Fragment",
    "Cost": "—",
    "ATK": "—",
    "HP": "—",
    "Rules Text": "Burn: +2 Ash Fragments. Place on top of graveyard instead of normal.",
    "Flavor Text": ""
  },
  {
    "Name": "Eternal Ember Fragment",
    "Faction": "Ash",
    "Type": "Fragment",
    "Cost": "—",
    "ATK": "—",
    "HP": "—",
    "Rules Text": "Burn: +1 Ash Fragment. On reburn, shuffle into deck instead of exile.",
    "Flavor Text": ""
  },
  {
    "Name": "Cinderfall Relic",
    "Faction": "Ash",
    "Type": "Fragment",
    "Cost": "—",
    "ATK": "—",
    "HP": "—",
    "Rules Text": "Burn: +3 Ash Fragments. Exile 1 card from your hand.",
    "Flavor Text": ""
  },
  {
    "Name": "Phantom Veil Fragment",
    "Faction": "Ash",
    "Type": "Fragment",
    "Cost": "—",
    "ATK": "—",
    "HP": "—",
    "Rules Text": "Burn: +2 Ash Fragments. Exile 1 card from your graveyard.",
    "Flavor Text": ""
  },
  {
    "Name": "Bone-Ash Keystone",
    "Faction": "Ash",
    "Type": "Fragment",
    "Cost": "—",
    "ATK": "—",
    "HP": "—",
    "Rules Text": "Burn: +1 any Fragment. Shuffle 2 cards from graveyard into deck.",
    "Flavor Text": ""
  },
  {
    "Name": "Funeral Pyre Fragment",
    "Faction": "Ash",
    "Type": "Fragment",
    "Cost": "—",
    "ATK": "—",
    "HP": "—",
    "Rules Text": "Burn: +2 Ash Fragments. Exile after use.",
    "Flavor Text": ""
  },
  {
    "Name": "Wraithfire Fragment",
    "Faction": "Ash",
    "Type": "Fragment",
    "Cost": "—",
    "ATK": "—",
    "HP": "—",
    "Rules Text": "Burn: +2 Ash Fragments. Exile after use. Opponent creates 1 Wraith token.",
    "Flavor Text": ""
  },
  {
    "Name": "Blood Fragment",
    "Faction": "Blood",
    "Type": "Fragment",
    "Cost": "",
    "ATK": "",
    "HP": "",
    "Rules Text": "Burn: Provides 🩸 Blood to cast creatures, spells, or relics.\nReburn: Pay 1 HP to shuffle this Fragment into your Fragment Deck, or sacrifice a creature to return it to your hand.\nFlavor: “The covenant of crimson demands either blood or bone.”",
    "Flavor Text": ""
  },
  {
    "Name": "Blood Fragment",
    "Faction": "Blood",
    "Type": "Fragment",
    "Cost": "—",
    "ATK": "—",
    "HP": "—",
    "Rules Text": "Burn: Provides 1 Blood resource. Reburn: Pay 1 HP to return to Fragment Deck or sacrifice a creature to return to hand.",
    "Flavor Text": "A shard steeped in crimson vows, binding life and death."
  },
  {
    "Name": "Crimson Pactstone",
    "Faction": "Blood",
    "Type": "Fragment",
    "Cost": "—",
    "ATK": "—",
    "HP": "—",
    "Rules Text": "Burn: +3 Blood Fragments. Pay 3 HP.",
    "Flavor Text": ""
  },
  {
    "Name": "Veinspire Shard",
    "Faction": "Blood",
    "Type": "Fragment",
    "Cost": "—",
    "ATK": "—",
    "HP": "—",
    "Rules Text": "Burn: +2 Blood Fragments. Sacrifice a creature.",
    "Flavor Text": ""
  },
  {
    "Name": "Throne-Blood Fragment",
    "Faction": "Blood",
    "Type": "Fragment",
    "Cost": "—",
    "ATK": "—",
    "HP": "—",
    "Rules Text": "Burn: +2 Blood Fragments. Opponent gains 1 HP.",
    "Flavor Text": ""
  },
  {
    "Name": "Sanguine Reliquary",
    "Faction": "Blood",
    "Type": "Fragment",
    "Cost": "—",
    "ATK": "—",
    "HP": "—",
    "Rules Text": "Burn: +2 Blood Fragments. Mill 3 cards from your deck.",
    "Flavor Text": ""
  },
  {
    "Name": "Obsidian Chalice",
    "Faction": "Blood",
    "Type": "Fragment",
    "Cost": "—",
    "ATK": "—",
    "HP": "—",
    "Rules Text": "Burn: +2 Blood Fragments. While in graveyard, you lose 1 HP every Upkeep.",
    "Flavor Text": ""
  },
  {
    "Name": "Hemorrhage Fragment",
    "Faction": "Blood",
    "Type": "Fragment",
    "Cost": "—",
    "ATK": "—",
    "HP": "—",
    "Rules Text": "Burn: +2 Blood Fragments. Exile after use.",
    "Flavor Text": ""
  },
  {
    "Name": "Vampiric Surge Fragment",
    "Faction": "Blood",
    "Type": "Fragment",
    "Cost": "—",
    "ATK": "—",
    "HP": "—",
    "Rules Text": "Burn: +3 Blood Fragments. Exile after use. Lose 2 HP.",
    "Flavor Text": ""
  },
  {
    "Name": "Flame Fragment",
    "Faction": "Flame",
    "Type": "Fragment",
    "Cost": "",
    "ATK": "",
    "HP": "",
    "Rules Text": "Burn: Provides 🔥 Flame to cast creatures, spells, or relics.\nReburn: Deal 1 damage to your own War Chief.\nFlavor: “The fire feeds your ambition, but every spark leaves a scar.”",
    "Flavor Text": ""
  },
  {
    "Name": "Flame Fragment",
    "Faction": "Flame",
    "Type": "Fragment",
    "Cost": "—",
    "ATK": "—",
    "HP": "—",
    "Rules Text": "Burn: Provides 1 Flame resource. Reburn: Deal 1 damage to your War Chief.",
    "Flavor Text": "The fury of the Inner Furnace, searing even its wielder."
  },
  {
    "Name": "Infernal Core",
    "Faction": "Flame",
    "Type": "Fragment",
    "Cost": "—",
    "ATK": "—",
    "HP": "—",
    "Rules Text": "Burn: +3 Flame Fragments. Lose 2 HP.",
    "Flavor Text": ""
  },
  {
    "Name": "Cinderheart",
    "Faction": "Flame",
    "Type": "Fragment",
    "Cost": "—",
    "ATK": "—",
    "HP": "—",
    "Rules Text": "Burn: +2 Flame Fragments. Exile top 2 cards of your deck.",
    "Flavor Text": ""
  },
  {
    "Name": "Blazing Rift",
    "Faction": "Flame",
    "Type": "Fragment",
    "Cost": "—",
    "ATK": "—",
    "HP": "—",
    "Rules Text": "Burn: +2 Flame Fragments. Reburn: deal 1 damage to your Leader.",
    "Flavor Text": ""
  },
  {
    "Name": "Volcanic Pulse",
    "Faction": "Flame",
    "Type": "Fragment",
    "Cost": "—",
    "ATK": "—",
    "HP": "—",
    "Rules Text": "Burn: +2 Flame Fragments. Opponent draws 1 card.",
    "Flavor Text": ""
  },
  {
    "Name": "Ashstorm Vein",
    "Faction": "Flame",
    "Type": "Fragment",
    "Cost": "—",
    "ATK": "—",
    "HP": "—",
    "Rules Text": "Burn: +1 any Fragment. Exile after use.",
    "Flavor Text": ""
  },
  {
    "Name": "Magma Surge Fragment",
    "Faction": "Flame",
    "Type": "Fragment",
    "Cost": "—",
    "ATK": "—",
    "HP": "—",
    "Rules Text": "Burn: +2 Flame Fragments. Exile after use.",
    "Flavor Text": ""
  },
  {
    "Name": "Dragonfire Fragment",
    "Faction": "Flame",
    "Type": "Fragment",
    "Cost": "—",
    "ATK": "—",
    "HP": "—",
    "Rules Text": "Burn: +2 Flame Fragments. Exile after use. Deal 2 damage to War Chief.",
    "Flavor Text": ""
  }
];
const BUILTIN_CARDS = RAW_V9_CARDS.map(normalizeCard).concat(RAW_FRAGMENT_CARDS.map(normalizeCard));
const BUILTIN_PRESETS = {
  "Starter: Ash — Warden of Ashes (v3)": {
    "chief": [
      "Warden of the Stillborn"
    ],
    "main": [
      "Ashbound Walker",
      "Ashen Interdictor",
      "Bonewraith",
      "Cinder Shade",
      "Cinder Veilguard",
      "Dust-Crown Herald",
      "Dustmarch Scout",
      "Funeral Pike",
      "Grave Echo",
      "Graveclutch Champion",
      "Gravecold Footman",
      "Graveyard Sentinel",
      "Hauntweaver",
      "Mournblade Stalker",
      "Mourning Blade",
      "Night-Quiet Lancer",
      "Obsidian Channeler",
      "Obsidian Revenant",
      "Obsidian Skirmisher",
      "Shade-Touched Guard",
      "Shadowbind Adept",
      "Shroud Watcher",
      "Stillborn Regent",
      "Warden of the Quiet",
      "Wraith-Caller",
      "Black Sigil Stone",
      "Catafalque Standard",
      "Funerary Ring",
      "Graveglass Mirror",
      "Lamp of the Unquiet",
      "Mortuary Engine",
      "Obsidian Shrine",
      "Pall of Silence",
      "Sepulcher Banner",
      "Urn of the Forgotten",
      "Cross of Ashes",
      "Entomb Memory",
      "Funeral March",
      "Gravewind",
      "Line of Dust",
      "Night's Claim",
      "Shadow Bloom",
      "Silence the Living",
      "Wraithwalk"
    ],
    "frags": []
  },
  "Starter: Blood — Crimson Dominion (v3)": {
    "chief": [
      "Crimson Matriarch"
    ],
    "main": [
      "Bleak Surgeon",
      "Blood-Quenched Sentinel",
      "Bloodkeep Legionary",
      "Carnage Reclaimer",
      "Clotline Soldier",
      "Crimson Houndmaster",
      "Crimson Servitor",
      "Fleshmarket Warden",
      "Fleshshaper Acolyte",
      "Gorefane Watch",
      "Gravebond Champion",
      "Gravetithe Collector",
      "Grim Vicar",
      "Hemlock Ward",
      "Matriarch of the Tithe",
      "Ritual Butcher",
      "Sanguine Duelist",
      "Sanguine Harvester",
      "Scarlet Overseer",
      "Sinew Pikebearer",
      "Thirstsworn Aide",
      "Veinbound Guard",
      "Veinspeaker Adept",
      "Veinwhip Enforcer",
      "Vessel-Cutter",
      "Blood Altar",
      "Bone-Thread Loom",
      "Chalice of Tithes",
      "Crimson Court Standard",
      "Crucible of Flesh",
      "Gorewheel",
      "Red Chorus",
      "Sanguine Font",
      "Vat of Renewal",
      "Vein-Scribed Sigil",
      "Blood Price",
      "Claim the Fallen",
      "Crimson Cross",
      "Harvest Call",
      "Hemorrhage Line",
      "Leeching March",
      "Pulse of the Vein",
      "Ritual Rebuke",
      "Vessel's Command"
    ],
    "frags": []
  },
  "Starter: Flame — Emberfront Offensive (v3)": {
    "chief": [
      "High Pyre Commander"
    ],
    "main": [
      "Ashen Lancer",
      "Ashfield Militia",
      "Blazeborn Duelist",
      "Brimstone Runner",
      "Charwalker",
      "Cinderblade Adept",
      "Cinderline Scout",
      "Coalbrand Skirmisher",
      "Emberfoot Soldier",
      "Embergale Striker",
      "Emberstorm Herald",
      "Fireset Sentry",
      "Flamewake Stalker",
      "Heatwave Vanguard",
      "Ignition Raider",
      "Inferno Harrier",
      "Kindling Spearhand",
      "Molten Shocktroop",
      "Pyreforge Guard",
      "Pyreheart Champion",
      "Pyreplate Bruiser",
      "Scorchwing Captain",
      "Searbrand Marauder",
      "Torchline Pikeman",
      "Volcanic Reaver",
      "Ashen War-Drum",
      "Brimwall Bulwark",
      "Cinder Gate",
      "Crown of Sparks",
      "Crucible Array",
      "Emberfont Standard",
      "Flamewheel Engine",
      "Infernal Beacon",
      "Mantle of the Forge",
      "Pyreline Banner",
      "Ashfall Surge",
      "Brand the Earth",
      "Crossflare",
      "Emberlash",
      "Forge-Fire Volley",
      "Line of Cinders",
      "Pyreburst",
      "Scorching Advance",
      "Sear the Ranks"
    ],
    "frags": []
  }
}; // no presets for v9 unless provided

// ===== App (unchanged from your full version) =====
const deck = { main: [], frags: [], chief: [] };
let allCards = BUILTIN_CARDS.slice();
let presets = BUILTIN_PRESETS;

const $ = id => document.getElementById(id);
const cardsEl = $('cards'), mainList = $('mainList'), fragList = $('fragList'), chiefList = $('chiefList');

function escapeHtml(s){ return (s ?? '').replace(/[&<>"]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[ch])); }
function parseCostNumber(costStr){
  if (!costStr) return NaN;
  const digits  = [...String(costStr).matchAll(/\d+/g)].map(m => +m[0]);   // fixed
  const symbols = [...String(costStr).matchAll(/[🔥🩸🕯️]/g)].length;
  return (digits.reduce((a,b)=>a+b,0)) + symbols;
}

function filtered(){
  const f=$('faction').value.trim().toLowerCase();
  const t=$('type').value.trim().toLowerCase();
  const q=$('text').value.trim().toLowerCase();
  const cmin=$('costMin').value?+$('costMin').value:-Infinity;
  const cmax=$('costMax').value?+$('costMax').value:+Infinity;

  return allCards.filter(c=>{
    if (f && (c.faction||'').toLowerCase()!==f) return false;
    if (t){
      const ct=(c.type||'').toLowerCase();
      const matchType = t==='war chief' ? /war\s*chief/.test(ct) : t==='fragment' ? /fragment/.test(ct) : ct.startsWith(t); // fixed
      if (!matchType) return false;
    }
    if(q){
      const blob = `${c.name} ${c.type} ${c.faction} ${c.cost} ${c.text} ${c.flavor}`.toLowerCase();
      if(!blob.includes(q)) return false;
    }
    const est=parseCostNumber(c.cost); if(Number.isFinite(est) && (est<cmin||est>cmax)) return false;
    return true;
  });
}

function renderCards(list){
  cardsEl.innerHTML='';
  list.forEach(c=>{
    const el=document.createElement('div'); el.className='card';
    const costNum=parseCostNumber(c.cost);
    el.innerHTML=`
      <div class="row"><span class="name">${escapeHtml(c.name)}</span></div>
      <div class="row">
        <span class="tag">${c.faction||'—'}</span>
        <span class="tag">${c.type||'—'}</span>
        <span class="tag">Cost: ${c.cost||'—'}</span>
        ${c.atk&&c.hp?`<span class="tag">ATK ${c.atk} / HP ${c.hp}</span>`:''}
      </div>
      <div class="muted small">${escapeHtml(c.text||'')}</div>
      <div class="row" style="margin-top:6px;gap:6px;">
        <button class="btn" data-add="main">+ Main</button>
        <button class="btn" data-add="frag">+ Fragment</button>
        <button class="btn" data-add="chief">Set Chief</button>
        <div class="small muted" style="margin-left:auto">${Number.isFinite(costNum)?('Est Cost: '+costNum):''}</div>
      </div>`;

    el.querySelectorAll('button').forEach(b=>{
      b.addEventListener('click', ()=>{
        if(b.dataset.add==='main')  addToDeck('main', c);
        if(b.dataset.add==='frag')  addToDeck('frags', c);
        if(b.dataset.add==='chief') setChief(c);
        updateCounts();
      });
    });

    cardsEl.appendChild(el);
  });
  $('results').textContent = `${list.length} results`;
}

function renderDeckList(container, list, bucket){
  container.innerHTML='';
  list.forEach((c,i)=>{
    const li=document.createElement('div'); li.className='li';
    li.innerHTML=`<div>
        <div class="name">${escapeHtml(c.name)}</div>
        <div class="small muted">
          ${escapeHtml(c.faction||'')} • ${escapeHtml(c.type||'')} • Cost ${escapeHtml(c.cost||'—')}
          ${c.atk&&c.hp?` • ATK ${c.atk} / HP ${c.hp}`:''}
        </div>
      </div>`;
    const r=document.createElement('div');
    r.innerHTML = `<button class="btn" data-remove="${bucket}" data-idx="${i}">Remove</button>`;
    li.appendChild(r); container.appendChild(li);
  });
  container.querySelectorAll('button[data-remove]').forEach(btn =>
    btn.addEventListener('click', ()=>{
      const b=btn.dataset.remove, ix=+btn.dataset.idx;
      deck[b].splice(ix,1);
      renderAll();
    })
  );
}

function renderAll(){
  renderDeckList(mainList, deck.main, 'main');
  renderDeckList(fragList, deck.frags, 'frags');
  renderDeckList(chiefList, deck.chief, 'chief');
  updateCounts();
}

function updateCounts(){
  $('countMain').textContent  = `Main: ${deck.main.length}`;
  $('countFrags').textContent = `Fragments: ${deck.frags.length}`;
  $('countChief').textContent = `War Chiefs: ${deck.chief.length}`;
}

function addToDeck(bucket, card){
  const t=(card.type||'').toLowerCase();
  if(bucket==='frags' && !/fragment/.test(t)) toast('Tip: only Fragment cards belong in the Fragment deck.');
  if(bucket==='main'  &&  /fragment/.test(t))  toast('Tip: Fragments usually go in the Fragment deck.');
  if(bucket==='main') deck.main.push(card);
  else if(bucket==='frags') deck.frags.push(card);
  renderAll();
}

function setChief(card){
  if(!/war\s*chief/i.test(card.type||'')){ toast('Selected card is not a War Chief.'); return; } // fixed
  deck.chief.push(card);
  renderAll();
}

function clearDeck(){ deck.main.length=0; deck.frags.length=0; deck.chief.length=0; renderAll(); }

function validateDeck(){
  $('validationMsg').textContent =
    `Summary — Main: ${deck.main.length} • Fragments: ${deck.frags.length} • War Chiefs: ${deck.chief.length}`;
  $('validationMsg').className='small';
}

// Bulk add
function addAll(list, mode){
  list.forEach(card=>{
    let bucket = mode;
    if(mode==='auto'){
      if(/war\s*chief/i.test(card.type||'')) bucket='chief';
      else if(/fragment/i.test((card.type||'').toLowerCase())) bucket='frags';
      else bucket='main';
    }
    if(bucket==='chief') setChief(card);
    else addToDeck(bucket, card);
  });
  renderAll();
}

// ===== SHEET EXPORTER (unchanged) =====
const CAN=$('sheet'); const CTX=CAN.getContext('2d');
function pickSource(){ const s=$('sheetSource').value; if(s==='main') return [...deck.main]; if(s==='frags') return [...deck.frags]; if(s==='chief') return [...deck.chief]; return [...deck.chief,...deck.main,...deck.frags]; }
function drawRoundedRect(ctx,x,y,w,h,r){ const rr=Math.min(r,w/2,h/2); ctx.beginPath(); ctx.moveTo(x+rr,y); ctx.arcTo(x+w,y,x+w,y+h,rr); ctx.arcTo(x+w,y+h,x,y+h,rr); ctx.arcTo(x,y+h,x,y,rr); ctx.arcTo(x,y,x+w,y,rr); ctx.closePath(); }
function wrapText(ctx,text,x,y,maxW,lineH,maxLines){
  if(!text) return y;
  const words=String(text).split(/\s+/);
  let line='', lines=0;
  for(let n=0;n<words.length;n++){
    const test=line?line+' '+words[n]:words[n];
    const w=ctx.measureText(test).width;
    if(w>maxW && line){
      ctx.fillText(line,x,y); line=words[n]; y+=lineH; lines++;
      if(maxLines && lines>=maxLines-1){
        let rest=words.slice(n).join(' ');
        while(ctx.measureText(rest+'…').width>maxW && rest.length>0) rest=rest.slice(0,-1);
        ctx.fillText(rest+'…',x,y);
        return y+lineH;
      }
    } else { line=test; }
  }
  if(line){ ctx.fillText(line,x,y); y+=lineH; }
  return y;
}
function factionTint(f){ f=(f||'').toLowerCase(); if(f.includes('flame')) return '#ff7a4a'; if(f.includes('blood')) return '#d94763'; if(f.includes('ash')) return '#b6b1a9'; return '#8aa3ff'; }

function renderCard(ctx,card,x,y,w,h,opts){
  const {bleed=36,setCode=''}=opts;
  const nameScale=Math.max(0.5,parseFloat(($('nameScale').value||'1')));
  const rulesScale=Math.max(0.5,parseFloat(($('rulesScale').value||'1')));

  ctx.save(); 
  drawRoundedRect(ctx,x,y,w,h,24);

  // 🌈 Use user-selected card face background color
  ctx.fillStyle = (document.getElementById('cardBgColor')?.value || '#11151f');
  ctx.fill();

  ctx.strokeStyle='#2b3145';
  ctx.lineWidth=2;
  ctx.stroke();

  ctx.fillStyle=factionTint(card.faction); ctx.fillRect(x,y,w,12);

  const pad=20; let cx=x+pad, cy=y+pad+Math.round(14*nameScale);
  ctx.fillStyle='#e9ebef'; ctx.font=`bold ${Math.round(28*nameScale)}px system-ui`; ctx.fillText(card.name||'Unnamed',cx,cy);
  const cost=card.cost||'—'; ctx.font=`bold ${Math.round(22*nameScale)}px system-ui`; ctx.fillStyle='#cfd3da'; ctx.textAlign='right'; ctx.fillText(cost,x+w-pad,cy); ctx.textAlign='left'; cy+=Math.round(28*nameScale);
  ctx.fillStyle='#9aa0ac'; ctx.font=`${Math.round(14*nameScale)}px system-ui`; ctx.fillText(`${card.type || '—'}  •  ${card.faction || '—'}`,cx,cy); cy+=Math.round(14*nameScale);

  const boxY=cy+Math.round(10*rulesScale), boxH=h*0.46;
  drawRoundedRect(ctx,x+pad-6,boxY-18,w-2*pad+12,boxH+28,14); ctx.fillStyle='#141a26'; ctx.fill(); ctx.strokeStyle='#262d3f'; ctx.stroke();

  ctx.fillStyle='#e1e4ea'; const rulesSize=Math.round(16*rulesScale);
  ctx.font=`${rulesSize}px system-ui`; const textMaxW=w-2*pad-10; let ty=boxY;
  ty=wrapText(ctx,(card.text||''),x+pad,ty,textMaxW,Math.round(20*rulesScale),10);

  if(card.flavor){
    ctx.fillStyle='#a5acb8'; ctx.font=`italic ${Math.round(14*rulesScale)}px system-ui`;
    wrapText(ctx,'“'+card.flavor+'”',x+pad,ty+Math.round(6*rulesScale),textMaxW,Math.round(18*rulesScale),3);
  }

  if(/war\s*chief/i.test(card.type||'')){
    const r=Math.round(32*nameScale); ctx.beginPath(); ctx.arc(x+w-pad-r,y+h-pad-r,r,0,Math.PI*2);
    ctx.fillStyle='#232a3d'; ctx.fill(); ctx.strokeStyle='#3a4563'; ctx.lineWidth=Math.max(2,Math.round(3*nameScale)); ctx.stroke();
    ctx.fillStyle='#e9ebef'; ctx.font=`bold ${Math.round(22*nameScale)}px system-ui`;
    const hp=(card.hp||'').toString()||'40'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(hp,x+w-pad-r,y+h-pad-r);
    ctx.textAlign='left'; ctx.textBaseline='alphabetic';
  } else if(!/fragment/i.test((card.type||'').toLowerCase())){
    const bw=Math.round(90*nameScale), bh=Math.round(48*nameScale);
    drawRoundedRect(ctx,x+w-pad-bw,y+h-pad-bh,bw,bh,Math.round(10*nameScale));
    ctx.fillStyle='#232a3d'; ctx.fill(); ctx.strokeStyle='#3a4563'; ctx.lineWidth=Math.max(1,Math.round(2*nameScale)); ctx.stroke();
    ctx.fillStyle='#e9ebef'; ctx.font=`bold ${Math.round(20*nameScale)}px system-ui`;
    ctx.fillText(`${card.atk||'—'} / ${card.hp||'—'}`, x+w-pad-bw+Math.round(12*nameScale), y+h-pad-bh+Math.round(30*nameScale));
  } else {
    ctx.fillStyle='#8e95a3'; ctx.font=`bold ${Math.round(16*nameScale)}px system-ui`;
    ctx.fillText('Fragment', x+w-pad-Math.round(120*nameScale), y+h-pad-Math.round(18*nameScale));
  }

  if(setCode){ ctx.fillStyle='#80889a'; ctx.font=`bold ${Math.round(13*nameScale)}px system-ui`; ctx.fillText(setCode, x+pad, y+h-pad); }
  ctx.restore();
}

function computeGrid(){ const rows=+document.getElementById('rows').value||7; const cols=+document.getElementById('cols').value||10; const cardW=+document.getElementById('cardW').value||744; const cardH=+document.getElementById('cardH').value||1038; const margin=+document.getElementById('margin').value||24; const scale=Math.max(1,+document.getElementById('scale').value||1); const bleed=+document.getElementById('bleed').value||0; const setCode=document.getElementById('setCode').value.trim(); return {rows,cols,cardW,cardH,margin,scale,bleed,setCode}; }
function allocCanvas(W,H,scale){ const c=document.createElement('canvas'); c.width=Math.floor(W*scale); c.height=Math.floor(H*scale); const ctx=c.getContext('2d'); ctx.setTransform(scale,0,0,scale,0,0); return {c,ctx}; }
function drawPage(ctx,cards,grid){ const {rows,cols,cardW,cardH,margin,bleed,setCode}=grid; const W=cols*cardW+(cols+1)*margin; const H=rows*cardH+(rows+1)*margin; ctx.fillStyle='#0b0b0e'; ctx.fillRect(0,0,W,H); for(let i=0;i<cards.length;i++){ const r=Math.floor(i/cols), c=i%cols; const x=margin+c*(cardW+margin); const y=margin+r*(cardH+margin); renderCard(ctx,cards[i],x,y,cardW,cardH,{bleed,setCode}); } }
function renderSheet(){ const src=pickSource(); if(!src.length){ toast('No cards in the chosen section.'); return; } const g=computeGrid(); const per=g.rows*g.cols; const pageCards=src.slice(0,per); const W=g.cols*g.cardW+(g.cols+1)*g.margin; const H=g.rows*g.cardH+(g.rows+1)*g.margin; CAN.width=Math.floor(W*g.scale); CAN.height=Math.floor(H*g.scale); CTX.setTransform(g.scale,0,0,g.scale,0,0); drawPage(CTX,pageCards,g); }
async function downloadAllSheets(){ const src=pickSource(); if(!src.length){ toast('No cards to export.'); return; } const g=computeGrid(); const per=g.rows*g.cols; const total=Math.ceil(src.length/per); const base=sheetLabel(); for(let p=0;p<total;p++){ const slice=src.slice(p*per,(p+1)*per); const W=g.cols*g.cardW+(g.cols+1)*g.margin; const H=g.rows*g.cardH+(g.rows+1)*g.margin; const {c,ctx}=allocCanvas(W,H,g.scale); drawPage(ctx,slice,g); await new Promise(res=>c.toBlob(b=>{download(`${base}_p${p+1}.png`,b);res();},'image/png')); } }
function previewAllSheets(){ const src=pickSource(); if(!src.length){ toast('No cards to preview.'); return; } const g=computeGrid(); const per=g.rows*g.cols; const total=Math.ceil(src.length/per); for(let p=0;p<total;p++){ const slice=src.slice(p*per,(p+1)*per); const W=g.cols*g.cardW+(g.cols+1)*g.margin; const H=g.rows*g.cardH+(g.rows+1)*g.margin; const {c,ctx}=allocCanvas(W,H,g.scale); drawPage(ctx,slice,g); const url=c.toDataURL('image/png'); const w=window.open('','_blank'); if(w){ w.document.write(`<title>Sheet ${p+1}/${total}</title><style>html,body{margin:0;background:#0b0b0e}img{display:block;margin:0 auto;max-width:100%;height:auto}</style><img src="${url}" alt="Card Sheet ${p+1}">`); w.document.close(); } } }
function sheetLabel(){ const s=document.getElementById('sheetSource').value; if(s==='main') return 'star_of_ash_main'; if(s==='frags') return 'star_of_ash_fragments'; if(s==='chief') return 'star_of_ash_chiefs'; return 'star_of_ash_all'; }
function renderBacks(){ const g=computeGrid(); const {rows,cols,cardW,cardH,margin}=g; const label=document.getElementById('backLabel').value||'Star of Ash'; const color=document.getElementById('backColor').value||'#0b0b0e'; const W=cols*cardW+(cols+1)*margin; const H=rows*cardH+(rows+1)*margin; CAN.width=Math.floor(W*g.scale); CAN.height=Math.floor(H*g.scale); CTX.setTransform(g.scale,0,0,g.scale,0,0); CTX.fillStyle='#0b0b0e'; CTX.fillRect(0,0,W,H); for(let r=0;r<rows;r++){ for(let c=0;c<cols;c++){ const x=margin+c*(cardW+margin), y=margin+r*(cardH+margin); drawRoundedRect(CTX,x,y,cardW,cardH,24); CTX.fillStyle=color; CTX.fill(); CTX.strokeStyle='#222633'; CTX.lineWidth=2; CTX.stroke(); CTX.save(); CTX.translate(x+cardW/2,y+cardH/2); CTX.fillStyle='#e7e8ea'; CTX.font='bold 40px system-ui'; CTX.textAlign='center'; CTX.textBaseline='middle'; CTX.fillText(label,0,0); CTX.restore(); } } }
function downloadSheet(){ CAN.toBlob(b=>download(`${sheetLabel()}_p1.png`,b),'image/png'); }
function openLargePreview(){ if(CAN.width===0||CAN.height===0) renderSheet(); const url=CAN.toDataURL('image/png'); const w=window.open('','_blank'); if(!w){ toast('Popup blocked'); return; } w.document.write('<title>Card Sheet Preview</title><style>html,body{margin:0;background:#0b0b0e}img{display:block;margin:0 auto;max-width:100%;height:auto}</style><img src="'+url+'" alt="Card Sheet Preview">'); w.document.close(); }

// Events
['faction','type','text','costMin','costMax'].forEach(id=>$(id).addEventListener('input', ()=>renderCards(filtered())));
$('clear').addEventListener('click', ()=>{ ['faction','type','text','costMin','costMax'].forEach(id=>$(id).value=''); renderCards(filtered()); });
$('addAllFiltered').addEventListener('click', ()=> addAll(filtered(), document.getElementById('addAllMode').value));
$('addAllAll').addEventListener('click', ()=> addAll(allCards, document.getElementById('addAllMode').value));
$('clearDeck').addEventListener('click', clearDeck);
$('validate').addEventListener('click', validateDeck);

function download(filename, blobOrText){
  const blob = blobOrText instanceof Blob ? blobOrText : new Blob([blobOrText],{type:'text/plain'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); URL.revokeObjectURL(a.href);
}
$('exportJson').addEventListener('click', ()=>download('star_of_ash_deck.json', JSON.stringify(deck,null,2)));
$('exportCsv').addEventListener('click', ()=>{
  const rows=[['Section','Card Name','Faction','Type','Cost','ATK','HP','Rules Text','Flavor Text']];
  const pushRow=(section,c)=>rows.push([section,c.name,c.faction||'',c.type||'',c.cost||'',c.atk||'',c.hp||'',
    (c.text||'').replace(/\r?\n/g,' '),(c.flavor||'').replace(/\r?\n/g,' ')]);
  deck.chief.forEach(c=>pushRow('War Chief',c));
  deck.main.forEach(c=>pushRow('Main',c));
  deck.frags.forEach(c=>pushRow('Fragments',c));
  const csv = rows.map(r => r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  download('star_of_ash_deck.csv', csv);
});
$('exportTxt').addEventListener('click', ()=>{
  const out=[];
  if(deck.chief.length) out.push('# War Chief', ...deck.chief.map(c=>c.name), '');
  if(deck.main.length)  out.push(`# Main (${deck.main.length})`,  ...deck.main.map(c=>c.name), '');
  if(deck.frags.length) out.push(`# Fragments (${deck.frags.length})`, ...deck.frags.map(c=>c.name), '');
  download('star_of_ash_deck.txt', out.join('\n'));
});

$('renderSheet').addEventListener('click', renderSheet);
$('renderBacks').addEventListener('click', renderBacks);
$('downloadSheet').addEventListener('click', downloadSheet);
$('previewFull').addEventListener('click', openLargePreview);
$('downloadAll').addEventListener('click', downloadAllSheets);
$('previewAll').addEventListener('click', previewAllSheets);

// Presets init
function refreshPresetSelect(){ const sel=$('presetSelect'); sel.innerHTML=''; const names=Object.keys(presets).sort(); names.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o); }); if(names[0]) sel.value=names[0]; }
function namesToCards(names){ const set = new Set((names||[]).map(s=>String(s).toLowerCase())); return allCards.filter(c=> set.has(String(c.name).toLowerCase())); }
function applyPreset(name, mode){ const p=presets[name]; if(!p) return; if(mode==='replace') clearDeck(); if(p.chief) deck.chief.push(...namesToCards(p.chief)); if(p.main) deck.main.push(...namesToCards(p.main)); if(p.frags) deck.frags.push(...namesToCards(p.frags)); renderAll(); }
$('loadPresetAppend').addEventListener('click', ()=>applyPreset(document.getElementById('presetSelect').value,'append'));
$('loadPresetReplace').addEventListener('click', ()=>applyPreset(document.getElementById('presetSelect').value,'replace'));

// Start
(function init(){ refreshPresetSelect(); renderCards(filtered()); })();

function toast(msg){ const el=document.getElementById('validationMsg'); el.textContent=msg; el.className='small warn'; setTimeout(()=>{ el.textContent=''; }, 3000); }
})();
</script>
</body></html>
