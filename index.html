<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Star of Ash — Deck Builder (CSV)</title>
<style>
  :root{
    --bg:#0b0d0f; --panel:#14181c; --panel2:#1b2026; --ink:#e6edf3;
    --muted:#9aa7b2; --accent:#6aa9ff; --ok:#33c48f; --warn:#ffb454; --err:#ff6b6b; --border:#28313a;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Arial}
  header{padding:12px 16px;background:#111;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:20}
  header h1{margin:0;font-size:18px;letter-spacing:.2px}
  main{display:grid;grid-template-columns:340px 1fr 380px;gap:16px;padding:16px;max-width:1600px;margin:0 auto}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;overflow:hidden}
  .section{padding:12px 12px;border-bottom:1px solid var(--border)}
  .section:last-child{border-bottom:0}
  .title{margin:0 0 8px;font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:.12em}
  label{display:block;font-size:12px;color:var(--muted);margin:6px 0 4px}
  input,select{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:var(--panel2);color:var(--ink)}
  input[type="number"]{width:100px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:var(--panel2);color:var(--ink);cursor:pointer}
  .btn.primary{background:var(--accent);color:#081020;border-color:transparent}
  .btn.ok{background:var(--ok);color:#02180f;border-color:transparent}
  .btn.warn{background:var(--warn);color:#2a1f00;border-color:transparent}
  .btn.ghost{background:transparent}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .status{padding:8px 12px;background:#101418;border-top:1px solid var(--border);color:var(--muted);font-size:12px}
  .status.danger{color:var(--err)}
  /* Table */
  table{width:100%;border-collapse:collapse}
  thead th{position:sticky;top:0;background:#101418;border-bottom:1px solid var(--border);padding:8px;font-size:12px;text-align:left;cursor:pointer}
  tbody td{padding:8px;border-bottom:1px solid var(--border);font-size:13px;vertical-align:middle}
  tbody tr:hover{background:#171d23}
  .qtybox{display:inline-flex;align-items:center;gap:6px}
  .qtybox input{width:56px;text-align:center}
  .small{font-size:12px;color:var(--muted)}
  .right{display:flex;gap:10px;align-items:center;justify-content:flex-end}
  .tag{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;color:var(--muted);font-size:11px;margin-right:6px}
  .stats{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .statbox{background:var(--panel2);border:1px solid var(--border);border-radius:10px;padding:10px}
  canvas{width:100%;height:160px;background:#0d1014;border:1px solid var(--border);border-radius:10px}
  .list{max-height:55vh;overflow:auto}
</style>
</head>
<body>
<header>
  <h1>⭐ Star of Ash — Deck Builder (CSV)</h1>
</header>

<main>
  <!-- LEFT: DATA & FILTERS -->
  <aside class="panel">
    <div class="section">
      <p class="title">Card Database</p>
      <label>Upload CSV</label>
      <input id="csvFile" type="file" accept=".csv" />
      <label class="small" style="display:flex;align-items:center;gap:8px;margin-top:8px">
        <input id="replaceDb" type="checkbox" /> Replace existing database (unchecked = append)
      </label>
      <div class="toolbar" style="margin-top:8px">
        <button class="btn" id="btnExportDb">Export current DB CSV</button>
        <button class="btn" id="btnClearDb">Clear DB</button>
      </div>
    </div>

    <div class="section">
      <p class="title">Filters</p>
      <label>Search (name / rules / flavor)</label>
      <input id="q" type="text" placeholder="e.g., Grasp, Ember" />
      <div class="row" style="margin-top:8px">
        <div>
          <label>Faction</label>
          <select id="faction"><option value="">All</option></select>
        </div>
        <div>
          <label>Type</label>
          <select id="ctype"><option value="">All</option></select>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <label>Cost ≤</label>
          <input id="maxCost" type="number" min="0" step="1" placeholder="e.g., 5" />
        </div>
        <div>
          <label>Min ATK / Min HP</label>
          <div style="display:flex;gap:6px">
            <input id="minAtk" type="number" min="0" step="1" placeholder="ATK" />
            <input id="minHp" type="number" min="0" step="1" placeholder="HP" />
          </div>
        </div>
      </div>
      <div class="toolbar" style="margin-top:10px">
        <button class="btn" id="btnReset">Reset Filters</button>
      </div>
    </div>

    <div class="section">
      <p class="title">Sort</p>
      <div class="row">
        <div>
          <label>Column</label>
          <select id="sortCol">
            <option value="name">Name</option>
            <option value="faction">Faction</option>
            <option value="ctype">Type</option>
            <option value="cost">Cost</option>
            <option value="atk">ATK</option>
            <option value="hp">HP</option>
          </select>
        </div>
        <div>
          <label>Direction</label>
          <select id="sortDir">
            <option value="asc">Ascending</option>
            <option value="desc">Descending</option>
          </select>
        </div>
      </div>
    </div>

    <div class="status" id="status">Load a CSV to begin.</div>
  </aside>

  <!-- CENTER: CARD TABLE -->
  <section class="panel">
    <div class="section" style="border-bottom:0">
      <p class="title">Card Pool</p>
      <div class="small" id="poolInfo">0 cards</div>
    </div>
    <div class="list">
      <table id="cardTable">
        <thead>
          <tr>
            <th data-col="name">Name</th>
            <th data-col="faction">Faction</th>
            <th data-col="ctype">Type</th>
            <th data-col="cost">Cost</th>
            <th data-col="atk">ATK</th>
            <th data-col="hp">HP</th>
            <th>Rules</th>
            <th class="right">Add</th>
          </tr>
        </thead>
        <tbody id="cardTbody">
          <!-- rows injected -->
        </tbody>
      </table>
    </div>
  </section>

  <!-- RIGHT: DECK -->
  <aside class="panel">
    <div class="section">
      <p class="title">Your Deck</p>
      <div class="small" id="deckInfo">0 cards</div>
      <div class="toolbar" style="margin-top:8px">
        <button class="btn ok" id="btnExportDeckCSV">Export Deck CSV</button>
        <button class="btn" id="btnExportDeckJSON">Export Deck JSON</button>
        <button class="btn" id="btnCopyList">Copy Text List</button>
      </div>
      <div class="toolbar" style="margin-top:8px">
        <input id="deckJsonFile" type="file" accept=".json" />
        <button class="btn" id="btnImportDeckJSON">Import Deck JSON</button>
        <button class="btn warn" id="btnClearDeck">Clear Deck</button>
      </div>
    </div>

    <div class="section">
      <div class="stats">
        <div class="statbox">
          <div class="small">Faction Breakdown</div>
          <div id="factionBreak"></div>
        </div>
        <div class="statbox">
          <div class="small">Average ATK / HP</div>
          <div id="avgStats"></div>
        </div>
      </div>
    </div>

    <div class="section">
      <p class="title">Cost Curve</p>
      <canvas id="curve" width="340" height="160"></canvas>
    </div>

    <div class="section">
      <p class="title">Deck List</p>
      <div class="list" style="max-height:40vh">
        <table id="deckTable">
          <thead>
            <tr>
              <th>Qty</th><th>Name</th><th>Faction</th><th>Type</th><th>Cost</th>
              <th class="right">Actions</th>
            </tr>
          </thead>
          <tbody id="deckTbody"></tbody>
        </table>
      </div>
    </div>
  </aside>
</main>

<script>
(function(){
  const $ = (sel) => document.querySelector(sel);
  const status = $('#status');
  let DB = [];          // full card database (array of objects)
  let filtered = [];    // filtered view for table
  const deck = new Map();// key -> { card, qty }
  let sortCol = 'name', sortDir='asc';

  // --- Error guard ---
  window.addEventListener('error', (e)=>{
    status.textContent = 'Error: ' + (e.message || e.error || 'Unknown');
    status.classList.add('danger');
    console.error(e);
  });

  // --- CSV parsing ---
  function parseCSV(text){
    const rows = [];
    let i=0, field='', row=[], inQuotes=false;
    while (i < text.length){
      const ch = text[i];
      if (inQuotes){
        if (ch === '"'){
          if (text[i+1] === '"'){ field += '"'; i+=2; continue; }
          inQuotes = false; i++; continue;
        } else { field += ch; i++; continue; }
      } else {
        if (ch === '"'){ inQuotes = true; i++; continue; }
        if (ch === ','){ row.push(field); field=''; i++; continue; }
        if (ch === '\r'){ i++; continue; }
        if (ch === '\n'){ row.push(field); rows.push(row); field=''; row=[]; i++; continue; }
        field += ch; i++; continue;
      }
    }
    row.push(field); rows.push(row);
    return rows.filter(r => r.length>1 || (r.length===1 && r[0].trim()!==''));
  }
  const norm = s => String(s||'').trim();
  const lower = s => norm(s).toLowerCase();

  function csvToObjects(text){
    const rows = parseCSV(text);
    if (!rows.length) return [];
    const header = rows[0].map(lower);
    const idx = (keys)=> {
      for (const k of keys){ const i = header.indexOf(lower(k)); if (i>=0) return i; }
      return -1;
    };
    const map = {
      name:   idx(['name','card name','title']),
      faction:idx(['faction']),
      ctype:  idx(['card type','type','ctype']),
      cost:   idx(['cost','mana','energy']),
      atk:    idx(['atk','attack']),
      hp:     idx(['hp','health']),
      rules:  idx(['rules','text','rules text']),
      flavor: idx(['flavor','flavor text']),
      id:     idx(['id','card id']),
      artUrl: idx(['arturl','art url','image','imageurl'])
    };
    const out = [];
    for (let r=1;r<rows.length;r++){
      const row = rows[r];
      const obj = {
        name:   map.name>=0 ? norm(row[map.name]) : '',
        faction:map.faction>=0 ? norm(row[map.faction]) : '',
        ctype:  map.ctype>=0 ? norm(row[map.ctype]) : '',
        cost:   map.cost>=0 ? parseInt(row[map.cost]||'0',10) : 0,
        atk:    map.atk>=0 ? parseInt(row[map.atk]||'0',10) : 0,
        hp:     map.hp>=0 ? parseInt(row[map.hp]||'0',10) : 0,
        rules:  map.rules>=0 ? norm(row[map.rules]) : '',
        flavor: map.flavor>=0 ? norm(row[map.flavor]) : '',
        id:     map.id>=0 ? norm(row[map.id]) : '',
        artUrl: map.artUrl>=0 ? norm(row[map.artUrl]) : ''
      };
      if (obj.name) out.push(obj);
    }
    return out;
  }

  // --- DB ops ---
  function loadCSVFile(file){
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const objs = csvToObjects(String(reader.result||''));
        if ($('#replaceDb').checked) DB = [];
        DB.push(...objs);
        dedupeDB();
        rebuildFilters();
        applyFilters();
        status.textContent = `Loaded ${objs.length} cards. DB now ${DB.length}.`;
        status.classList.remove('danger');
      }catch(err){
        status.textContent = 'CSV error: ' + (err.message||err);
        status.classList.add('danger');
      }
    };
    reader.onerror = ()=>{ status.textContent='CSV read failed.'; status.classList.add('danger'); };
    reader.readAsText(file);
  }

  function dedupeDB(){
    const seen = new Map();
    const keyOf = c => (c.id?lower(c.id):'') + '|' + lower(c.name) + '|' + lower(c.faction) + '|' + lower(c.ctype);
    const out = [];
    for (const c of DB){
      const k = keyOf(c);
      if (!seen.has(k)){ seen.set(k,1); out.push(c); }
    }
    DB = out;
  }

  function exportDBCsv(){
    const cols = ['name','faction','ctype','cost','atk','hp','rules','flavor','id','artUrl'];
    const esc = v => {
      const s = String(v??'');
      return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    };
    const lines = [];
    lines.push(cols.join(','));
    DB.forEach(c=>{
      lines.push(cols.map(k=>esc(c[k])).join(','));
    });
    download('card_database.csv', lines.join('\n'));
  }

  // --- Filters & Sorting ---
  function rebuildFilters(){
    // factions/types from DB
    const fSel = $('#faction'); const tSel = $('#ctype');
    const factions = Array.from(new Set(DB.map(c=>c.faction).filter(Boolean))).sort();
    const ctypes = Array.from(new Set(DB.map(c=>c.ctype).filter(Boolean))).sort();
    fSel.innerHTML = '<option value="">All</option>' + factions.map(f=>`<option>${escapeHtml(f)}</option>`).join('');
    tSel.innerHTML = '<option value="">All</option>' + ctypes.map(t=>`<option>${escapeHtml(t)}</option>`).join('');
  }

  function applyFilters(){
    const q = lower($('#q').value);
    const faction = $('#faction').value;
    const ctype = $('#ctype').value;
    const maxCost = parseInt($('#maxCost').value||'',10);
    const minAtk = parseInt($('#minAtk').value||'',10);
    const minHp = parseInt($('#minHp').value||'',10);

    filtered = DB.filter(c=>{
      if (faction && c.faction !== faction) return false;
      if (ctype && c.ctype !== ctype) return false;
      if (!isNaN(maxCost) && c.cost > maxCost) return false;
      if (!isNaN(minAtk) && c.atk < minAtk) return false;
      if (!isNaN(minHp) && c.hp < minHp) return false;
      if (q){
        const hay = lower(c.name+' '+c.rules+' '+c.flavor);
        if (!hay.includes(q)) return false;
      }
      return true;
    });

    sortFiltered();
    renderCardTable();
    $('#poolInfo').textContent = `${filtered.length} cards (DB: ${DB.length})`;
  }

  function sortFiltered(){
    const col = sortCol, dir = sortDir==='asc'?1:-1;
    filtered.sort((a,b)=>{
      let x=a[col], y=b[col];
      if (typeof x==='string') x = x.toLowerCase();
      if (typeof y==='string') y = y.toLowerCase();
      if (x<y) return -1*dir;
      if (x>y) return 1*dir;
      return 0;
    });
  }

  // --- Card Table ---
  function renderCardTable(){
    const tbody = $('#cardTbody');
    tbody.innerHTML = '';
    const frag = document.createDocumentFragment();
    filtered.forEach((c,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(c.name)}</td>
        <td>${escapeHtml(c.faction||'')}</td>
        <td>${escapeHtml(c.ctype||'')}</td>
        <td>${num(c.cost)}</td>
        <td>${num(c.atk)}</td>
        <td>${num(c.hp)}</td>
        <td class="small">${escapeHtml(shorten(c.rules,140))}</td>
        <td class="right">
          <div class="qtybox">
            <button class="btn" data-act="minus">-</button>
            <input type="number" min="0" step="1" value="1" />
            <button class="btn" data-act="plus">+</button>
            <button class="btn primary" data-act="add">Add</button>
          </div>
        </td>
      `;
      const qtyInput = tr.querySelector('input[type="number"]');
      tr.querySelector('[data-act="minus"]').onclick = ()=>{ qtyInput.value = Math.max(0, (parseInt(qtyInput.value)||0)-1); };
      tr.querySelector('[data-act="plus"]').onclick = ()=>{ qtyInput.value = (parseInt(qtyInput.value)||0)+1; };
      tr.querySelector('[data-act="add"]').onclick = ()=>{
        const qty = Math.max(0, parseInt(qtyInput.value)||0);
        if (qty>0) addToDeck(c, qty);
      };
      frag.appendChild(tr);
    });
    tbody.appendChild(frag);
  }

  // --- Deck ---
  function keyFor(c){ return (c.id?lower(c.id):'') + '|' + lower(c.name); }

  function addToDeck(card, qty){
    const k = keyFor(card);
    const cur = deck.get(k);
    if (cur) cur.qty += qty; else deck.set(k, {card, qty});
    renderDeck();
  }
  function setDeckQty(k, qty){
    const cur = deck.get(k);
    if (!cur) return;
    if (qty<=0) deck.delete(k); else cur.qty = qty;
    renderDeck();
  }
  function clearDeck(){
    deck.clear();
    renderDeck();
  }

  function deckArray(){
    return Array.from(deck.values()).map(({card,qty})=>({card,qty}));
  }

  function renderDeck(){
    const tbody = $('#deckTbody'); tbody.innerHTML = '';
    const frag = document.createDocumentFragment();
    let total = 0;
    deckArray().forEach(({card,qty})=>{
      total += qty;
      const k = keyFor(card);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="number" min="0" step="1" value="${qty}" style="width:60px" /></td>
        <td>${escapeHtml(card.name)}</td>
        <td class="small">${escapeHtml(card.faction||'')}</td>
        <td class="small">${escapeHtml(card.ctype||'')}</td>
        <td>${num(card.cost)}</td>
        <td class="right">
          <button class="btn" data-act="dec">-</button>
          <button class="btn" data-act="inc">+</button>
          <button class="btn warn" data-act="rm">Remove</button>
        </td>
      `;
      const qtyInput = tr.querySelector('input[type="number"]');
      qtyInput.onchange = ()=> setDeckQty(k, Math.max(0, parseInt(qtyInput.value)||0));
      tr.querySelector('[data-act="dec"]').onclick = ()=> setDeckQty(k, Math.max(0, (parseInt(qtyInput.value)||0)-1));
      tr.querySelector('[data-act="inc"]').onclick = ()=> setDeckQty(k, (parseInt(qtyInput.value)||0)+1);
      tr.querySelector('[data-act="rm"]').onclick  = ()=> setDeckQty(k, 0);
      frag.appendChild(tr);
    });
    tbody.appendChild(frag);
    $('#deckInfo').textContent = `${total} cards in deck`;

    // stats
    renderStats();
    renderCurve();
  }

  function renderStats(){
    const byFaction = countBy(deckArray(), x=>x.card.faction||'');
    const fb = Object.entries(byFaction).sort((a,b)=>b[1]-a[1]).map(([f,n])=>`<span class="tag">${escapeHtml(f||'—')}: ${n}</span>`).join(' ');
    $('#factionBreak').innerHTML = fb || '<span class="small">—</span>';

    const nums = deckArray().flatMap(({card,qty})=>{
      return Array(qty).fill({atk:card.atk||0, hp:card.hp||0});
    });
    const avgAtk = (nums.reduce((s,x)=>s+x.atk,0)/(nums.length||1)).toFixed(2);
    const avgHp  = (nums.reduce((s,x)=>s+x.hp,0)/(nums.length||1)).toFixed(2);
    $('#avgStats').innerHTML = `<span class="tag">ATK ${avgAtk}</span> <span class="tag">HP ${avgHp}</span>`;
  }

  function renderCurve(){
    const ctx = $('#curve').getContext('2d');
    ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
    // build counts by cost 0..9
    const counts = Array(10).fill(0);
    deckArray().forEach(({card,qty})=>{
      const c = clamp(parseInt(card.cost)||0, 0, 9);
      counts[c] += qty;
    });
    const W = ctx.canvas.width, H = ctx.canvas.height, pad = 20;
    const max = Math.max(1, ...counts);
    const bw = (W - pad*2) / counts.length;
    // axes
    ctx.strokeStyle = '#304050'; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(pad, H-pad); ctx.lineTo(W-pad, H-pad); ctx.stroke();
    // bars
    for (let i=0;i<counts.length;i++){
      const h = Math.round((H - pad*2) * (counts[i] / max));
      const x = pad + i*bw + 4, y = H - pad - h;
      ctx.fillStyle = '#6aa9ff';
      ctx.fillRect(x, y, bw-8, h);
      ctx.fillStyle = '#9aa7b2';
      ctx.font = '12px system-ui';
      ctx.fillText(String(i), pad + i*bw + bw/2 - 3, H - pad + 12);
    }
  }

  // --- Exports / Imports (deck) ---
  function exportDeckCSV(){
    const cols = ['qty','name','faction','ctype','cost','atk','hp','id'];
    const esc = v => {
      const s = String(v??'');
      return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    };
    const lines = [cols.join(',')];
    deckArray().forEach(({card,qty})=>{
      lines.push([
        qty, card.name, card.faction, card.ctype, card.cost, card.atk, card.hp, card.id
      ].map(esc).join(','));
    });
    download('deck.csv', lines.join('\n'));
  }

  function exportDeckJSON(){
    const obj = deckArray().map(({card,qty})=>({qty, card}));
    download('deck.json', JSON.stringify(obj, null, 2));
  }

  function copyDeckList(){
    const lines = deckArray().map(({card,qty})=>`${qty}x ${card.name} (${card.faction} • ${card.ctype} • ${card.cost})`);
    const txt = lines.join('\n');
    navigator.clipboard.writeText(txt).then(()=>{
      toast('Deck list copied to clipboard');
    }).catch(()=>{ toast('Copy failed'); });
  }

  function importDeckJSONFile(file){
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const arr = JSON.parse(String(reader.result||''));
        deck.clear();
        arr.forEach(x=>{
          // try match card from DB by name+id, else keep provided
          const key = keyFor(x.card);
          const match = DB.find(c=> keyFor(c)===key) || x.card;
          deck.set(keyFor(match), {card: match, qty: parseInt(x.qty)||0});
        });
        renderDeck();
        status.textContent = 'Deck JSON imported.';
        status.classList.remove('danger');
      }catch(e){
        status.textContent = 'Deck JSON parse error.';
        status.classList.add('danger');
      }
    };
    reader.onerror = ()=>{ status.textContent='Deck JSON read failed.'; status.classList.add('danger'); };
    reader.readAsText(file);
  }

  // --- Utils ---
  function download(filename, content){
    const a = document.createElement('a');
    a.download = filename;
    a.href = URL.createObjectURL(new Blob([content], {type:'text/plain'}));
    a.click();
    URL.revokeObjectURL(a.href);
  }
  function num(n){ return (n===0 || n) ? String(n) : ''; }
  function clamp(v, mn, mx){ return Math.max(mn, Math.min(mx, v)); }
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function shorten(s, n){ s=String(s||''); return s.length>n ? s.slice(0,n-1)+'…' : s; }
  function countBy(arr, fn){ const m={}; for(const x of arr){ const k=fn(x); m[k]=(m[k]||0)+ (x.qty||1); } return m; }
  function toast(msg){ status.textContent = msg; setTimeout(()=>status.textContent='', 1500); }

  // --- Wiring ---
  $('#csvFile').addEventListener('change', e=>{
    const f = e.target.files[0];
    if (f) loadCSVFile(f);
  });
  $('#btnExportDb').onclick = exportDBCsv;
  $('#btnClearDb').onclick = ()=>{ DB=[]; filtered=[]; applyFilters(); rebuildFilters(); status.textContent='Database cleared.'; };

  ['q','faction','ctype','maxCost','minAtk','minHp'].forEach(id=>{
    document.getElementById(id).addEventListener('input', applyFilters);
  });
  $('#btnReset').onclick = ()=>{
    $('#q').value=''; $('#faction').value=''; $('#ctype').value='';
    $('#maxCost').value=''; $('#minAtk').value=''; $('#minHp').value='';
    applyFilters();
  };
  $('#sortCol').onchange = (e)=>{ sortCol = e.target.value; sortFiltered(); renderCardTable(); };
  $('#sortDir').onchange = (e)=>{ sortDir = e.target.value; sortFiltered(); renderCardTable(); };

  // header click sort (center table)
  document.querySelectorAll('#cardTable thead th[data-col]').forEach(th=>{
    th.addEventListener('click', ()=>{
      const c = th.getAttribute('data-col');
      if (sortCol===c){ sortDir = (sortDir==='asc'?'desc':'asc'); } else { sortCol=c; sortDir='asc'; }
      $('#sortCol').value = sortCol; $('#sortDir').value = sortDir;
      sortFiltered(); renderCardTable();
    });
  });

  // deck buttons
  $('#btnExportDeckCSV').onclick = exportDeckCSV;
  $('#btnExportDeckJSON').onclick = exportDeckJSON;
  $('#btnCopyList').onclick = copyDeckList;
  $('#btnClearDeck').onclick = clearDeck;
  $('#btnImportDeckJSON').onclick = ()=>{
    const f = $('#deckJsonFile').files[0];
    if (f) importDeckJSONFile(f);
  };

  // init
  applyFilters();
  renderDeck();
})();
</script>
</body>
</html>
