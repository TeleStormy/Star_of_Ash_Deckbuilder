<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Star of Ash â€” Deck Builder + Sheet Exporter (v9 FIXED)</title>
<style>
:root { --bg:#0f0f13; --panel:#171923; --muted:#9aa0ac; --text:#e7e8ea; --accent:#b389ff; --ok:#6dd37a; --warn:#ffb84d; --bad:#ff6b6b; --line:#222633; }
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
header{padding:16px 20px;border-bottom:1px solid #222;display:flex;gap:12px;align-items:center;position:sticky;top:0;background:rgba(15,15,19,.95);backdrop-filter:saturate(140%) blur(6px);flex-wrap:wrap}
header h1{font-size:16px;margin:0;font-weight:700;letter-spacing:.4px}
.btn{padding:8px 12px;border-radius:10px;border:1px solid #2a2d3a;background:#1d2030;color:var(--text);cursor:pointer}
.btn:hover{border-color:#3a3f52} .btn.primary{background:var(--accent);border-color:var(--accent);color:#0e061a;font-weight:700}
.layout{display:grid;grid-template-columns:360px 1fr 380px;gap:16px;padding:16px}
.panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;overflow:hidden;display:flex;flex-direction:column;min-height:0}
.panel h2{margin:0;padding:12px 14px;border-bottom:1px solid #23283a;font-size:13px;letter-spacing:.3px;text-transform:uppercase;color:var(--muted)}
.panel .body{padding:12px;display:flex;flex-direction:column;gap:10px;min-height:0}
input,select{width:100%;background:#141722;border:1px solid #2a2d3a;color:var(--text);border-radius:10px;padding:8px;min-height:38px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.cards{overflow:auto;min-height:0;display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
.card{background:#141722;border:1px solid #252a3a;border-radius:12px;padding:10px;display:flex;flex-direction:column;gap:6px}
.tag{font-size:11px;color:#b7bdc9;background:#1e2230;border:1px solid #2a2f43;border-radius:999px;padding:2px 8px;margin-right:6px}
.name{font-weight:700} .muted{color:var(--muted)}
.deckcol{display:flex;flex-direction:column;gap:10px;min-height:0}
.list{overflow:auto;min-height:140px;border:1px dashed #2c3144;border-radius:12px;padding:8px;display:flex;flex-direction:column;gap:6px}
.li{display:flex;justify-content:space-between;gap:8px;border:1px solid #2a2d3a;background:#111421;border-radius:10px;padding:8px}
.counts{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
.pill{padding:6px 8px;border-radius:999px;text-align:center;background:#141722;border:1px solid #2a2d3a}
footer{padding:12px 16px;border-top:1px solid var(--line);display:flex;gap:8px;justify-content:flex-end}
.small{font-size:12px}
.field{display:flex;flex-direction:column;gap:4px} .field label{font-size:11px;color:var(--muted)} .hint{font-size:11px;color:var(--muted)}
@media (max-width:1200px){.layout{grid-template-columns:1fr}}
@media (max-width:520px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <h1>Star of Ash â€” Deck Builder + Sheet Exporter (v9 FIXED)</h1>
  <button id="exportJson" class="btn">Export Deck (JSON)</button>
  <button id="exportCsv" class="btn">Export Deck (CSV)</button>
  <button id="exportTxt" class="btn">Export Names (TXT)</button>
  <div class="small muted" id="status">Data: v9 (normalized)</div>
</header>

<div class="layout">
  <section class="panel">
    <h2>Filters</h2>
    <div class="body">
      <div class="grid">
        <div class="field"><label>Faction</label><select id="faction">
          <option value="">All Factions</option><option>Flame</option><option>Blood</option><option>Ash</option>
          <option>Flame/Blood</option><option>Blood/Ash</option><option>Flame/Ash</option>
        </select></div>
        <div class="field"><label>Card Type</label><select id="type">
          <option value="">All Types</option><option>Creature</option><option>Spell</option><option>Relic</option><option>War Chief</option><option>Fragment</option>
        </select></div>
        <div class="field"><label>Search</label><input id="text" placeholder="Name, rules, flavorâ€¦" /></div>
        <div class="field"><label>Min Cost (est.)</label><input id="costMin" type="number" min="0" placeholder="0" /></div>
        <div class="field"><label>Max Cost (est.)</label><input id="costMax" type="number" min="0" placeholder="âˆž" /></div>
      </div>
      <div class="row"><button id="clear" class="btn">Clear Filters</button><div class="small muted" id="results"></div></div>
    </div>
  </section>

  <section class="panel"><h2>Cards</h2><div class="body" style="min-height:400px"><div class="cards" id="cards"></div></div></section>
  <section class="panel"><h2>Deck</h2><div class="body deckcol">
    <div class="counts"><div class="pill" id="countMain">Main: 0</div><div class="pill" id="countFrags">Fragments: 0</div><div class="pill" id="countChief">War Chiefs: 0</div></div>
    <div class="small muted">Main</div><div class="list" id="mainList"></div>
    <div class="small muted">Fragments</div><div class="list" id="fragList"></div>
    <div class="small muted">War Chiefs</div><div class="list" id="chiefList"></div>
    <footer><button id="validate" class="btn primary">Summary</button><div id="validationMsg" class="small"></div></footer>
  </div></section>
</div>

<script>
// ===== Raw v9 Cards (as uploaded) =====
const RAW_V9_CARDS = [
  {
    "Name": "Ashen Lancer",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "3 Flame Fragments",
    "ATK": 5,
    "HP": 3,
    "Rules Text": "Overheat 1 â€” When this attacks, it gains +1 ATK this turn, then takes 1 damage at end of turn."
  },
  {
    "Name": "Ashfield Militia",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "2 Flame Fragments",
    "ATK": 4,
    "HP": 3,
    "Rules Text": ""
  },
  {
    "Name": "Blazeborn Duelist",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "3 Flame Fragments",
    "ATK": 3,
    "HP": 4,
    "Rules Text": "Ignite â€” When this deals damage, adjacent enemies to the target take 1 damage."
  },
  {
    "Name": "Brimstone Runner",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "3 Flame Fragments",
    "ATK": 4,
    "HP": 2,
    "Rules Text": ""
  },
  {
    "Name": "Charwalker",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "3 Flame Fragments",
    "ATK": 2,
    "HP": 4,
    "Rules Text": ""
  },
  {
    "Name": "Cinderblade Adept",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "4 Flame Fragments",
    "ATK": 4,
    "HP": 3,
    "Rules Text": "Surge â€” This unit may move and attack during the same turn."
  },
  {
    "Name": "Cinderline Scout",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "3 Flame Fragments",
    "ATK": 3,
    "HP": 2,
    "Rules Text": ""
  },
  {
    "Name": "Coalbrand Skirmisher",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "2 Flame Fragments",
    "ATK": 3,
    "HP": 4,
    "Rules Text": ""
  },
  {
    "Name": "Emberfoot Soldier",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "2 Flame Fragments",
    "ATK": 3,
    "HP": 3,
    "Rules Text": ""
  },
  {
    "Name": "Embergale Striker",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "4 Flame Fragments",
    "ATK": 3,
    "HP": 5,
    "Rules Text": "Molten Shield â€” Prevent the first 1 damage dealt to this each turn."
  },
  {
    "Name": "Emberstorm Herald",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "5 Flame Fragments",
    "ATK": 6,
    "HP": 3,
    "Rules Text": "Commanded Flame â€” When you cast a Spell, this gains +1 ATK until end of turn."
  },
  {
    "Name": "Fireset Sentry",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "3 Flame Fragments",
    "ATK": 3,
    "HP": 3,
    "Rules Text": ""
  },
  {
    "Name": "Flamewake Stalker",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "4 Flame Fragments",
    "ATK": 3,
    "HP": 4,
    "Rules Text": "Flow East â€” At the end of your turn, move this 1 tile east if unoccupied."
  },
  {
    "Name": "Heatwave Vanguard",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "4 Flame Fragments",
    "ATK": 5,
    "HP": 2,
    "Rules Text": "Rekindle â€” When this destroys a unit, heal 1 HP."
  },
  {
    "Name": "Ignition Raider",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "4 Flame Fragments",
    "ATK": 4,
    "HP": 3,
    "Rules Text": "Rend â€” Attacks pierce through the first enemy hit and deal -1 damage to the next unit in line."
  },
  {
    "Name": "Inferno Harrier",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "3 Flame Fragments",
    "ATK": 4,
    "HP": 2,
    "Rules Text": "Flow Forward â€” At the end of your turn, move this 1 tile forward if unoccupied."
  },
  {
    "Name": "Kindling Spearhand",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "2 Flame Fragments",
    "ATK": 3,
    "HP": 3,
    "Rules Text": ""
  },
  {
    "Name": "Molten Shocktroop",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "4 Flame Fragments",
    "ATK": 5,
    "HP": 4,
    "Rules Text": "Eruption (-): When this attacks, after damage resolve, deal 1 damage in a line forward (friendly fire)."
  },
  {
    "Name": "Pyreforge Guard",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "3 Flame Fragments",
    "ATK": 2,
    "HP": 3,
    "Rules Text": ""
  },
  {
    "Name": "Pyreheart Champion",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "5 Flame Fragments",
    "ATK": 5,
    "HP": 3,
    "Rules Text": "When Deployed â€” Allies in its column gain +1 ATK this turn. Overheat 1."
  },
  {
    "Name": "Pyreplate Bruiser",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "3 Flame Fragments",
    "ATK": 3,
    "HP": 5,
    "Rules Text": "Swift â€” This unit may act on the turn it is deployed (move or attack)."
  },
  {
    "Name": "Scorchwing Captain",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "6 Flame Fragments",
    "ATK": 4,
    "HP": 5,
    "Rules Text": "Swift. Rend â€” Attacks pierce; the second target takes -1 damage."
  },
  {
    "Name": "Searbrand Marauder",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "3 Flame Fragments",
    "ATK": 4,
    "HP": 3,
    "Rules Text": "Ember Step â€” When this moves, gain +1 ATK until end of turn."
  },
  {
    "Name": "Torchline Pikeman",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "2 Flame Fragments",
    "ATK": 4,
    "HP": 3,
    "Rules Text": ""
  },
  {
    "Name": "Volcanic Reaver",
    "Faction": "Flame",
    "Type": "Creature",
    "Cost": "4 Flame Fragments",
    "ATK": 4,
    "HP": 4,
    "Rules Text": "When Deployed â€” Eruption (+): deal 2 damage (friendly fire). Surge â€” This may move and attack during the same turn."
  },
  {
    "Name": "Ashen War-Drum",
    "Faction": "Flame",
    "Type": "Relic",
    "Cost": "2 Flame Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Allies in the center column gain +1 ATK. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Brimwall Bulwark",
    "Faction": "Flame",
    "Type": "Relic",
    "Cost": "4 Flame Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Prevent the first 2 damage dealt to your units each turn; those units take 1 damage at end of turn (overheat). (Relic overwrite rules apply.)"
  },
  {
    "Name": "Cinder Gate",
    "Faction": "Flame",
    "Type": "Relic",
    "Cost": "3 Flame Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Eruption (+): When you deploy a creature, deal 1 damage (friendly fire). (Relic overwrite rules apply.)"
  },
  {
    "Name": "Crown of Sparks",
    "Faction": "Flame",
    "Type": "Relic",
    "Cost": "2 Flame Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Your Spells cost 1 less Fragment this turn after a creature dies. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Crucible Array",
    "Faction": "Flame",
    "Type": "Relic",
    "Cost": "2 Flame Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Once per turn, you may move an allied unit 1 tile after it attacks. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Emberfont Standard",
    "Faction": "Flame",
    "Type": "Relic",
    "Cost": "3 Flame Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "At end of your turn, create a Flamefield on a random empty tile in your front two rows. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Flamewheel Engine",
    "Faction": "Flame",
    "Type": "Relic",
    "Cost": "4 Flame Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Relic Fuse â€” You may destroy this: deal 3 damage to a unit in line of sight. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Infernal Beacon",
    "Faction": "Flame",
    "Type": "Relic",
    "Cost": "2 Flame Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Allied Flame units gain +1 ATK this turn when they move. (Newest Relic overrides oldest; max 4 Relics total between both players.)"
  },
  {
    "Name": "Mantle of the Forge",
    "Faction": "Flame",
    "Type": "Relic",
    "Cost": "4 Flame Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Allied units entering Flamefields gain +1 ATK until end of turn. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Pyreline Banner",
    "Faction": "Flame",
    "Type": "Relic",
    "Cost": "3 Flame Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "When an allied unit destroys an enemy, draw 1 card. Pay 1 HP to keep this Relic at end of turn; otherwise destroy it. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Ashfall Surge",
    "Faction": "Flame",
    "Type": "Spell",
    "Cost": "2 Flame Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Move an allied unit 1 tile, then it gains +1 ATK this turn. You may cast this on any player's turn."
  },
  {
    "Name": "Brand the Earth",
    "Faction": "Flame",
    "Type": "Spell",
    "Cost": "2 Flame Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Target allied unit gains Surge until end of turn. You may cast this on any player's turn."
  },
  {
    "Name": "Crossflare",
    "Faction": "Flame",
    "Type": "Spell",
    "Cost": "3 Flame Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Until end of turn, two target allies gain +1 ATK. You may cast this on any player's turn."
  },
  {
    "Name": "Emberlash",
    "Faction": "Flame",
    "Type": "Spell",
    "Cost": "3 Flame Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Create a Flamefield on an empty tile within 2 tiles of a Flame unit. You may cast this on any player's turn."
  },
  {
    "Name": "Forge-Fire Volley",
    "Faction": "Flame",
    "Type": "Spell",
    "Cost": "1 Flame Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Choose a column: enemies in that column take 1 damage. You may cast this on any player's turn."
  },
  {
    "Name": "Line of Cinders",
    "Faction": "Flame",
    "Type": "Spell",
    "Cost": "2 Flame Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Eruption (+) â€” Deal 2 damage in a cross (friendly fire). You may cast this on any player's turn."
  },
  {
    "Name": "Pyreburst",
    "Faction": "Flame",
    "Type": "Spell",
    "Cost": "1 Flame Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Eruption (-) â€” Deal 2 damage in a line (friendly fire). You may cast this on any player's turn."
  },
  {
    "Name": "Scorching Advance",
    "Faction": "Flame",
    "Type": "Spell",
    "Cost": "1 Flame Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Choose a Flamefield: push all units adjacent to it 1 tile away. You may cast this on any player's turn."
  },
  {
    "Name": "Sear the Ranks",
    "Faction": "Flame",
    "Type": "Spell",
    "Cost": "3 Flame Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Destroy target Sigil or reduce a Relic's effect by half until your next turn. You may cast this on any player's turn."
  },
  {
    "Name": "High Pyre Commander",
    "Faction": "Flame",
    "Type": "War Chief",
    "Cost": "0 Flame Fragments",
    "ATK": 0,
    "HP": 40,
    "Rules Text": "Command (Free, 1/turn) â€” Choose a friendly Flame unit: it gains +1 ATK this turn and triggers Eruption (+) for 1 damage (friendly fire). Command (1 Flame Fragment, 1/turn) â€” Eruption (-) for 2 damage (friendly fire). War Chiefs cannot attack and may only move left or right in their back row."
  },
  {
    "Name": "Bleak Surgeon",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "4 Blood Fragments",
    "ATK": 3,
    "HP": 5,
    "Rules Text": "Gravecall â€” When this dies, you may spend 1 Blood Fragment to deploy it with -1 HP."
  },
  {
    "Name": "Blood-Quenched Sentinel",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "2 Blood Fragments",
    "ATK": 3,
    "HP": 4,
    "Rules Text": ""
  },
  {
    "Name": "Bloodkeep Legionary",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "4 Blood Fragments",
    "ATK": 3,
    "HP": 6,
    "Rules Text": "Life Tithe â€” Pay 1 HP: draw 1 card. Use once each of your turns."
  },
  {
    "Name": "Carnage Reclaimer",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "5 Blood Fragments",
    "ATK": 4,
    "HP": 6,
    "Rules Text": "Gravebond â€” When a friendly creature dies, this gains +1 ATK until end of turn. Feast."
  },
  {
    "Name": "Clotline Soldier",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "2 Blood Fragments",
    "ATK": 3,
    "HP": 5,
    "Rules Text": ""
  },
  {
    "Name": "Crimson Houndmaster",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "3 Blood Fragments",
    "ATK": 2,
    "HP": 6,
    "Rules Text": "Essence Surge â€” Whenever you heal, an enemy in line of sight gets -1 ATK until end of turn."
  },
  {
    "Name": "Crimson Servitor",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "2 Blood Fragments",
    "ATK": 2,
    "HP": 5,
    "Rules Text": ""
  },
  {
    "Name": "Fleshmarket Warden",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "6 Blood Fragments",
    "ATK": 3,
    "HP": 8,
    "Rules Text": "Relic Feeder â€” At end of your turn, you may sacrifice a friendly Summon: draw 1 card."
  },
  {
    "Name": "Fleshshaper Acolyte",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "3 Blood Fragments",
    "ATK": 3,
    "HP": 5,
    "Rules Text": "Guard â€” Enemies must attack this first if able."
  },
  {
    "Name": "Gorefane Watch",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "3 Blood Fragments",
    "ATK": 2,
    "HP": 6,
    "Rules Text": ""
  },
  {
    "Name": "Gravebond Champion",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "4 Blood Fragments",
    "ATK": 5,
    "HP": 6,
    "Rules Text": "Command the Vein â€” When you cast a Spell, heal 1 to a friendly creature; then an enemy in line loses 1 ATK this turn."
  },
  {
    "Name": "Gravetithe Collector",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "3 Blood Fragments",
    "ATK": 4,
    "HP": 5,
    "Rules Text": "Sigilmaker â€” You may place a Sigil face-down on an adjacent empty tile (triggers when stepped on)."
  },
  {
    "Name": "Grim Vicar",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "4 Blood Fragments",
    "ATK": 2,
    "HP": 6,
    "Rules Text": "Ritual Draw â€” When you destroy a unit, draw 1 card if your War Chief took damage this turn."
  },
  {
    "Name": "Hemlock Ward",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "3 Blood Fragments",
    "ATK": 2,
    "HP": 5,
    "Rules Text": ""
  },
  {
    "Name": "Matriarch of the Tithe",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "4 Blood Fragments",
    "ATK": 4,
    "HP": 7,
    "Rules Text": "When Deployed â€” Sacrifice another friendly creature: destroy an enemy with HP â‰¤ the sacrificed creature's HP."
  },
  {
    "Name": "Ritual Butcher",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "3 Blood Fragments",
    "ATK": 3,
    "HP": 5,
    "Rules Text": "Feast â€” When a unit dies on an adjacent tile, this heals 1 HP."
  },
  {
    "Name": "Sanguine Duelist",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "3 Blood Fragments",
    "ATK": 3,
    "HP": 5,
    "Rules Text": "Sacrificial Pact â€” Sacrifice a friendly creature: destroy an enemy with HP â‰¤ the sacrificed creature's HP."
  },
  {
    "Name": "Sanguine Harvester",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "5 Blood Fragments",
    "ATK": 5,
    "HP": 5,
    "Rules Text": "Claim the Blood â€” When this destroys a unit, you may pay 1 Blood Fragment: deploy it from your discard with -1 HP."
  },
  {
    "Name": "Scarlet Overseer",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "4 Blood Fragments",
    "ATK": 3,
    "HP": 6,
    "Rules Text": "Crimson Dice â€” When this enters, roll a d6. (1â€“3: gain 2 HP. 4â€“6: deal 2 to an enemy.)"
  },
  {
    "Name": "Sinew Pikebearer",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "2 Blood Fragments",
    "ATK": 3,
    "HP": 5,
    "Rules Text": ""
  },
  {
    "Name": "Thirstsworn Aide",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "3 Blood Fragments",
    "ATK": 2,
    "HP": 5,
    "Rules Text": ""
  },
  {
    "Name": "Veinbound Guard",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "3 Blood Fragments",
    "ATK": 2,
    "HP": 4,
    "Rules Text": ""
  },
  {
    "Name": "Veinspeaker Adept",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "4 Blood Fragments",
    "ATK": 2,
    "HP": 6,
    "Rules Text": "Dominion â€” Enemies entering adjacent tiles lose 1 ATK until your next turn."
  },
  {
    "Name": "Veinwhip Enforcer",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "3 Blood Fragments",
    "ATK": 4,
    "HP": 4,
    "Rules Text": "Flesh Armor â€” If this would die, you may sacrifice another friendly creature instead."
  },
  {
    "Name": "Vessel-Cutter",
    "Faction": "Blood",
    "Type": "Creature",
    "Cost": "4 Blood Fragments",
    "ATK": 3,
    "HP": 5,
    "Rules Text": "Retaliate 1 â€” When damaged, deal 1 back to the source."
  },
  {
    "Name": "Blood Altar",
    "Faction": "Blood",
    "Type": "Relic",
    "Cost": "2 Blood Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Whenever a unit dies, heal your War Chief 1 HP. (Newest Relic overrides oldest; max 4 Relics total between both players.)"
  },
  {
    "Name": "Bone-Thread Loom",
    "Faction": "Blood",
    "Type": "Relic",
    "Cost": "2 Blood Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Crimson Chant â€” Enemies on Bloodpools have -1 ATK. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Chalice of Tithes",
    "Faction": "Blood",
    "Type": "Relic",
    "Cost": "3 Blood Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Vessel's Boon â€” The first time an ally dies each turn, gain 1 temporary Fragment (Blood) this turn only. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Crimson Court Standard",
    "Faction": "Blood",
    "Type": "Relic",
    "Cost": "4 Blood Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Blood Ward â€” Allied creatures gain Guard this turn when healed. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Crucible of Flesh",
    "Faction": "Blood",
    "Type": "Relic",
    "Cost": "2 Blood Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Life Tithe â€” Once per turn you may pay 2 HP: draw 1 card. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Gorewheel",
    "Faction": "Blood",
    "Type": "Relic",
    "Cost": "4 Blood Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Tithe Counter â€” At end of your turn, if two or more enemies died, create a Bloodpool under one of them. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Red Chorus",
    "Faction": "Blood",
    "Type": "Relic",
    "Cost": "3 Blood Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Flesh Market â€” When you sacrifice a unit, draw 1 card. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Sanguine Font",
    "Faction": "Blood",
    "Type": "Relic",
    "Cost": "4 Blood Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "At end of your turn, spread a Bloodpool to an adjacent empty tile of a Blood unit. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Vat of Renewal",
    "Faction": "Blood",
    "Type": "Relic",
    "Cost": "2 Blood Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Relic Scour â€” When an ally is healed, on a roll of 5â€“6 destroy a random enemy Relic. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Vein-Scribed Sigil",
    "Faction": "Blood",
    "Type": "Relic",
    "Cost": "3 Blood Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Sigils you control deal +1 damage and apply Bleed (1). (Relic overwrite rules apply.)"
  },
  {
    "Name": "Blood Price",
    "Faction": "Blood",
    "Type": "Spell",
    "Cost": "3 Blood Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Blood Price â€” Pay 2 HP: draw 2 cards. You may cast this on any player's turn."
  },
  {
    "Name": "Claim the Fallen",
    "Faction": "Blood",
    "Type": "Spell",
    "Cost": "1 Blood Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Claim the Fallen â€” Pay 1 Blood Fragment: deploy a creature with cost â‰¤ 3 from your discard with -1 HP. You may cast this on any player's turn."
  },
  {
    "Name": "Crimson Cross",
    "Faction": "Blood",
    "Type": "Spell",
    "Cost": "2 Blood Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Ripple (x) â€” Drain 1 HP diagonally around the target; heal allies by the same amount. You may cast this on any player's turn."
  },
  {
    "Name": "Harvest Call",
    "Faction": "Blood",
    "Type": "Spell",
    "Cost": "3 Blood Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Harvest Call â€” If a unit died this turn, draw 1 card. Otherwise, discard 1 card. You may cast this on any player's turn."
  },
  {
    "Name": "Hemorrhage Line",
    "Faction": "Blood",
    "Type": "Spell",
    "Cost": "1 Blood Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Ripple (+) â€” Drain 1 HP from enemies in a cross; heal allies by the same amount. You may cast this on any player's turn."
  },
  {
    "Name": "Leeching March",
    "Faction": "Blood",
    "Type": "Spell",
    "Cost": "2 Blood Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Leeching March â€” Until end of turn, when allies deal damage, heal your War Chief 1 HP. You may cast this on any player's turn."
  },
  {
    "Name": "Pulse of the Vein",
    "Faction": "Blood",
    "Type": "Spell",
    "Cost": "2 Blood Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Pulse of the Vein â€” Choose an enemy: it gets -2 ATK until your next turn. You may cast this on any player's turn."
  },
  {
    "Name": "Ritual Rebuke",
    "Faction": "Blood",
    "Type": "Spell",
    "Cost": "1 Blood Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Ritual Rebuke â€” Sacrifice a friendly creature: destroy an enemy with HP â‰¤ the sacrificed creature's HP. You may cast this on any player's turn."
  },
  {
    "Name": "Vessel's Command",
    "Faction": "Blood",
    "Type": "Spell",
    "Cost": "3 Blood Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Vessel's Command â€” Choose a tile on a Bloodpool: enemies adjacent take 1 damage. You may cast this on any player's turn."
  },
  {
    "Name": "Crimson Matriarch",
    "Faction": "Blood",
    "Type": "War Chief",
    "Cost": "0 Blood Fragments",
    "ATK": 0,
    "HP": 45,
    "Rules Text": "Command (Free, 1/turn) â€” Ripple (+): Drain 1 HP from enemies around a friendly Blood unit; heal your War Chief by the total drained. Command (1 Blood Fragment, 1/turn) â€” Create Bloodpools on up to two empty tiles adjacent to Blood units you control. War Chiefs cannot attack and may only move left or right in their back row."
  },
  {
    "Name": "Ashbound Walker",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "2 Ash Fragments",
    "ATK": 3,
    "HP": 3,
    "Rules Text": ""
  },
  {
    "Name": "Ashen Interdictor",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "3 Ash Fragments",
    "ATK": 3,
    "HP": 4,
    "Rules Text": "Obsidian Step â€” When this moves, create a Shadow Tile on its previous tile."
  },
  {
    "Name": "Bonewraith",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "2 Ash Fragments",
    "ATK": 2,
    "HP": 4,
    "Rules Text": ""
  },
  {
    "Name": "Cinder Shade",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "4 Ash Fragments",
    "ATK": 3,
    "HP": 4,
    "Rules Text": "Shroud â€” Takes 1 less damage from all sources this turn after moving."
  },
  {
    "Name": "Cinder Veilguard",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "3 Ash Fragments",
    "ATK": 2,
    "HP": 5,
    "Rules Text": ""
  },
  {
    "Name": "Dust-Crown Herald",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "5 Ash Fragments",
    "ATK": 5,
    "HP": 4,
    "Rules Text": "Quiet Command â€” When this destroys a unit, you may pay 1 Ash Fragment: deploy a 1/1 Wraith token on an adjacent empty tile."
  },
  {
    "Name": "Dustmarch Scout",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "3 Ash Fragments",
    "ATK": 2,
    "HP": 5,
    "Rules Text": ""
  },
  {
    "Name": "Funeral Pike",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "2 Ash Fragments",
    "ATK": 3,
    "HP": 4,
    "Rules Text": ""
  },
  {
    "Name": "Grave Echo",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "4 Ash Fragments",
    "ATK": 3,
    "HP": 4,
    "Rules Text": "Ascend â€” When this moves to your back row, it gains +2 ATK."
  },
  {
    "Name": "Graveclutch Champion",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "4 Ash Fragments",
    "ATK": 5,
    "HP": 5,
    "Rules Text": "Obsidian Surge â€” When you cast a Spell, create a Shadow Tile on an empty adjacent tile."
  },
  {
    "Name": "Gravecold Footman",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "2 Ash Fragments",
    "ATK": 3,
    "HP": 3,
    "Rules Text": ""
  },
  {
    "Name": "Graveyard Sentinel",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "3 Ash Fragments",
    "ATK": 2,
    "HP": 4,
    "Rules Text": ""
  },
  {
    "Name": "Hauntweaver",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "3 Ash Fragments",
    "ATK": 2,
    "HP": 5,
    "Rules Text": "Reclaim â€” When this is deployed from your discard, draw 1 card."
  },
  {
    "Name": "Mournblade Stalker",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "3 Ash Fragments",
    "ATK": 3,
    "HP": 3,
    "Rules Text": "Wraithcall â€” When this dies, create a 1/1 Wraith token on its tile."
  },
  {
    "Name": "Mourning Blade",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "3 Ash Fragments",
    "ATK": 2,
    "HP": 4,
    "Rules Text": ""
  },
  {
    "Name": "Night-Quiet Lancer",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "4 Ash Fragments",
    "ATK": 2,
    "HP": 5,
    "Rules Text": "Grave Siphon â€” When an enemy dies adjacent, heal your War Chief 1 HP."
  },
  {
    "Name": "Obsidian Channeler",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "4 Ash Fragments",
    "ATK": 2,
    "HP": 5,
    "Rules Text": "Channel â€” If aligned in the same row or column with another allied Channel card, both gain +1 ATK."
  },
  {
    "Name": "Obsidian Revenant",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "6 Ash Fragments",
    "ATK": 4,
    "HP": 6,
    "Rules Text": "Dustbound â€” While on a Shadow Tile, this has +1 ATK and Guard."
  },
  {
    "Name": "Obsidian Skirmisher",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "2 Ash Fragments",
    "ATK": 3,
    "HP": 4,
    "Rules Text": ""
  },
  {
    "Name": "Shade-Touched Guard",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "3 Ash Fragments",
    "ATK": 2,
    "HP": 4,
    "Rules Text": ""
  },
  {
    "Name": "Shadowbind Adept",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "3 Ash Fragments",
    "ATK": 3,
    "HP": 4,
    "Rules Text": "Shadow Bind â€” Enemies on Shadow Tiles cannot move."
  },
  {
    "Name": "Shroud Watcher",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "4 Ash Fragments",
    "ATK": 3,
    "HP": 4,
    "Rules Text": "Night Veil â€” Enemies adjacent have -1 ATK."
  },
  {
    "Name": "Stillborn Regent",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "4 Ash Fragments",
    "ATK": 4,
    "HP": 5,
    "Rules Text": "When Deployed â€” Bloom (x): create Shadow Tiles diagonally around the target tile."
  },
  {
    "Name": "Warden of the Quiet",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "5 Ash Fragments",
    "ATK": 4,
    "HP": 5,
    "Rules Text": "Grave Conductor â€” When a friendly unit dies, you may move an allied unit 1 tile."
  },
  {
    "Name": "Wraith-Caller",
    "Faction": "Ash",
    "Type": "Creature",
    "Cost": "3 Ash Fragments",
    "ATK": 3,
    "HP": 4,
    "Rules Text": "Haunt â€” When this dies, its tile becomes haunted; enemies entering take 1 damage."
  },
  {
    "Name": "Black Sigil Stone",
    "Faction": "Ash",
    "Type": "Relic",
    "Cost": "4 Ash Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Sepulcher Echo â€” The first time an ally dies each turn, draw 1 card and then discard 1 card. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Catafalque Standard",
    "Faction": "Ash",
    "Type": "Relic",
    "Cost": "3 Ash Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "At the end of your turn, you may convert a Ruins tile into a Shadow Tile. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Funerary Ring",
    "Faction": "Ash",
    "Type": "Relic",
    "Cost": "3 Ash Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Silencing Pall â€” Enemies who enter Shadow Tiles cannot cast Spells until end of turn. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Graveglass Mirror",
    "Faction": "Ash",
    "Type": "Relic",
    "Cost": "2 Ash Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "When you cast a Spell, create a Shadow Tile on an empty tile adjacent to your War Chief. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Lamp of the Unquiet",
    "Faction": "Ash",
    "Type": "Relic",
    "Cost": "4 Ash Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "When an allied unit dies, 25% chance to deploy a 1/1 Wraith token on its tile. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Mortuary Engine",
    "Faction": "Ash",
    "Type": "Relic",
    "Cost": "3 Ash Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Gravetide â€” At end of your turn, if two enemies died this turn, create Shadow Tiles (+) around your War Chief. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Obsidian Shrine",
    "Faction": "Ash",
    "Type": "Relic",
    "Cost": "2 Ash Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Allied units on Shadow Tiles gain +1 ATK; enemies on Shadow Tiles have -1 ATK. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Pall of Silence",
    "Faction": "Ash",
    "Type": "Relic",
    "Cost": "2 Ash Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Obsidian Web â€” Enemies moving off Shadow Tiles take 1 damage. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Sepulcher Banner",
    "Faction": "Ash",
    "Type": "Relic",
    "Cost": "2 Ash Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Lamp of the Unquiet â€” Once per turn, you may move a Shadow Tile 1 space. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Urn of the Forgotten",
    "Faction": "Ash",
    "Type": "Relic",
    "Cost": "4 Ash Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "While you control 3+ Shadow Tiles, allied creatures gain +1 HP. (Relic overwrite rules apply.)"
  },
  {
    "Name": "Cross of Ashes",
    "Faction": "Ash",
    "Type": "Spell",
    "Cost": "2 Ash Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Bloom (+) â€” Create Shadow Tiles in a cross centered on target. You may cast this on any player's turn."
  },
  {
    "Name": "Entomb Memory",
    "Faction": "Ash",
    "Type": "Spell",
    "Cost": "3 Ash Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Entomb Memory â€” Put the top 2 cards of your deck into your discard; then draw 1. You may cast this on any player's turn."
  },
  {
    "Name": "Funeral March",
    "Faction": "Ash",
    "Type": "Spell",
    "Cost": "3 Ash Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Funeral March â€” Move up to two allied units 1 tile each. You may cast this on any player's turn."
  },
  {
    "Name": "Gravewind",
    "Faction": "Ash",
    "Type": "Spell",
    "Cost": "1 Ash Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Gravewind â€” Move a Shadow Tile 1 space; enemies it passes over take 1 damage. You may cast this on any player's turn."
  },
  {
    "Name": "Line of Dust",
    "Faction": "Ash",
    "Type": "Spell",
    "Cost": "3 Ash Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Bloom (-) â€” In a line, turn up to 3 empty tiles into Shadow Tiles. You may cast this on any player's turn."
  },
  {
    "Name": "Night's Claim",
    "Faction": "Ash",
    "Type": "Spell",
    "Cost": "2 Ash Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Night's Claim â€” Choose an enemy on a Shadow Tile: it cannot move next turn. You may cast this on any player's turn."
  },
  {
    "Name": "Shadow Bloom",
    "Faction": "Ash",
    "Type": "Spell",
    "Cost": "1 Ash Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Bloom (x) â€” Create Shadow Tiles diagonally around the target. You may cast this on any player's turn."
  },
  {
    "Name": "Silence the Living",
    "Faction": "Ash",
    "Type": "Spell",
    "Cost": "2 Ash Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Silence the Living â€” Target enemy loses 2 ATK until your next turn. You may cast this on any player's turn."
  },
  {
    "Name": "Wraithwalk",
    "Faction": "Ash",
    "Type": "Spell",
    "Cost": "1 Ash Fragments",
    "ATK": "",
    "HP": "",
    "Rules Text": "Wraithwalk â€” Target allied unit gains Swift until end of turn. You may cast this on any player's turn."
  },
  {
    "Name": "Warden of the Stillborn",
    "Faction": "Ash",
    "Type": "War Chief",
    "Cost": "0 Ash Fragments",
    "ATK": 0,
    "HP": 42,
    "Rules Text": "Command (Free, 1/turn) â€” Choose an empty tile adjacent to a fallen ally: deploy a 1/1 Wraith token. Command (1 Ash Fragment, 1/turn) â€” Bloom (x): Create Shadow Tiles on diagonally adjacent tiles of a chosen space. War Chiefs cannot attack and may only move left or right in their back row."
  }
];

// ===== Normalize v9 -> app schema =====
function normalizeCard(c) {
  const name   = c.Name ?? c.name ?? '';
  const faction= c.Faction ?? c.faction ?? '';
  const type   = c.Type ?? c.type ?? '';
  const cost   = c.Cost ?? c.cost ?? '';
  const atk    = (c.ATK ?? c.atk ?? '').toString();
  const hp     = (c.HP  ?? c.hp  ?? '').toString();
  const text   = c['Rules Text'] ?? c.text ?? '';
  const flavor = c['Flavor Text'] ?? c.flavor ?? '';
  return { name, faction, type, cost, atk, hp, text, flavor };
}

const BUILTIN_CARDS = RAW_V9_CARDS.map(normalizeCard);
const BUILTIN_PRESETS = {};

// ===== App =====
const deck = { main: [], frags: [], chief: [] };
let allCards = BUILTIN_CARDS.slice();
let presets = BUILTIN_PRESETS;

const $ = id => document.getElementById(id);
const cardsEl = $('cards'), mainList = $('mainList'), fragList = $('fragList'), chiefList = $('chiefList');

function escapeHtml(s){ return (s ?? '').replace(/[&<>"]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[ch])); }
function parseCostNumber(costStr){
  if (!costStr) return NaN;
  const digits  = [...String(costStr).matchAll(/\\d+/g)].map(m => +m[0]);
  const symbols = [...String(costStr).matchAll(/[ðŸ”¥ðŸ©¸ðŸ•¯ï¸]/g)].length;
  return (digits.reduce((a,b)=>a+b,0)) + symbols;
}

function filtered(){
  const f=$('faction').value.trim().toLowerCase();
  const t=$('type').value.trim().toLowerCase();
  const q=$('text').value.trim().toLowerCase();
  const cmin=$('costMin').value?+$('costMin').value:-Infinity;
  const cmax=$('costMax').value?+$('costMax').value:+Infinity;

  return allCards.filter(c=>{
    if (f && (c.faction||'').toLowerCase()!==f) return false;
    if (t){
      const ct=(c.type||'').toLowerCase();
      const matchType = t==='war chief' ? /war\\s*chief/.test(ct) : t==='fragment' ? /fragment/.test(ct) : ct.startsWith(t);
      if (!matchType) return false;
    }
    if(q){
      const blob = `${c.name} ${c.type} ${c.faction} ${c.cost} ${c.text} ${c.flavor}`.toLowerCase();
      if(!blob.includes(q)) return false;
    }
    const est=parseCostNumber(c.cost); if(Number.isFinite(est) && (est<cmin||est>cmax)) return false;
    return true;
  });
}

function renderCards(list){
  cardsEl.innerHTML='';
  list.forEach(c=>{
    const el=document.createElement('div'); el.className='card';
    const costNum=parseCostNumber(c.cost);
    el.innerHTML=`
      <div class="row"><span class="name">${escapeHtml(c.name)}</span></div>
      <div class="row">
        <span class="tag">${c.faction||'â€”'}</span>
        <span class="tag">${c.type||'â€”'}</span>
        <span class="tag">Cost: ${c.cost||'â€”'}</span>
        ${(c.atk && c.hp) ? `<span class="tag">ATK ${c.atk} / HP ${c.hp}</span>` : ''}
      </div>
      <div class="muted small">${escapeHtml(c.text||'')}</div>
      <div class="row" style="margin-top:6px;gap:6px;">
        <button class="btn" data-add="main">+ Main</button>
        <button class="btn" data-add="frag">+ Fragment</button>
        <button class="btn" data-add="chief">Set Chief</button>
        <div class="small muted" style="margin-left:auto">${Number.isFinite(costNum)?('Est Cost: '+costNum):''}</div>
      </div>`;

    el.querySelectorAll('button').forEach(b=>{
      b.addEventListener('click', ()=>{
        if(b.dataset.add==='main')  deck.main.push(c);
        if(b.dataset.add==='frag')  deck.frags.push(c);
        if(b.dataset.add==='chief') deck.chief.push(c);
        renderAll();
      });
    });

    cardsEl.appendChild(el);
  });
  $('results').textContent = `${list.length} results`;
}

function renderDeckList(container, list){
  container.innerHTML='';
  list.forEach((c)=>{
    const li=document.createElement('div'); li.className='li';
    li.innerHTML=`<div>
        <div class="name">${escapeHtml(c.name)}</div>
        <div class="small muted">
          ${escapeHtml(c.faction||'')} â€¢ ${escapeHtml(c.type||'')} â€¢ Cost ${escapeHtml(c.cost||'â€”')}
          ${(c.atk&&c.hp)?` â€¢ ATK ${c.atk} / HP ${c.hp}`:''}
        </div>
      </div>`;
    container.appendChild(li);
  });
}

function renderAll(){
  renderDeckList(mainList, deck.main);
  renderDeckList(fragList, deck.frags);
  renderDeckList(chiefList, deck.chief);
  $('countMain').textContent  = `Main: ${deck.main.length}`;
  $('countFrags').textContent = `Fragments: ${deck.frags.length}`;
  $('countChief').textContent = `War Chiefs: ${deck.chief.length}`;
}

function exportFile(filename, text){
  const blob = new Blob([text], {type:'text/plain'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); URL.revokeObjectURL(a.href);
}
document.getElementById('exportJson').addEventListener('click',()=>exportFile('star_of_ash_deck.json', JSON.stringify(deck,null,2)));
document.getElementById('exportCsv').addEventListener('click',()=>{
  const rows=[['Section','Card Name','Faction','Type','Cost','ATK','HP','Rules Text','Flavor Text']];
  const add=(section,arr)=>arr.forEach(c=>rows.push([section,c.name,c.faction||'',c.type||'',c.cost||'',c.atk||'',c.hp||'',(c.text||'').replace(/\\n/g,' '),(c.flavor||'').replace(/\\n/g,' ')]));
  add('War Chief',deck.chief); add('Main',deck.main); add('Fragments',deck.frags);
  const csv = rows.map(r => r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\\n');
  exportFile('star_of_ash_deck.csv', csv);
});
document.getElementById('exportTxt').addEventListener('click',()=>{
  const out=[];
  if(deck.chief.length) out.push('# War Chief', ...deck.chief.map(c=>c.name), '');
  if(deck.main.length)  out.push(`# Main (${deck.main.length})`,  ...deck.main.map(c=>c.name), '');
  if(deck.frags.length) out.push(`# Fragments (${deck.frags.length})`, ...deck.frags.map(c=>c.name), '');
  exportFile('star_of_ash_deck.txt', out.join('\\n'));
});

['faction','type','text','costMin','costMax'].forEach(id=>$(id).addEventListener('input', ()=>renderCards(filtered())));
$('clear').addEventListener('click', ()=>{ ['faction','type','text','costMin','costMax'].forEach(id=>$(id).value=''); renderCards(filtered()); });

renderCards(filtered());
</script>
</body>
</html>
